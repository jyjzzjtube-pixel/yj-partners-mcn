<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>YJ MCN Automation Hub</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0f1117;--card:#1a1d29;--card2:#222639;--border:#2d3148;--primary:#6366f1;--primary-light:#818cf8;--accent:#f59e0b;--green:#22c55e;--red:#ef4444;--blue:#3b82f6;--text:#e2e8f0;--text2:#94a3b8;--text3:#64748b;--naver:#03c75a;--youtube:#ff0000;--insta:#e4405f}
body{font-family:'Pretendard Variable','Noto Sans KR',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;line-height:1.5}
a{color:var(--primary-light);text-decoration:none}
button{font-family:inherit;cursor:pointer}
input,textarea,select{font-family:inherit}

/* Header */
.header{background:linear-gradient(135deg,#1e1b4b 0%,#312e81 50%,#1e1b4b 100%);border-bottom:1px solid var(--border);padding:16px 0}
.header-inner{max-width:1400px;margin:0 auto;padding:0 24px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px}
.logo{display:flex;align-items:center;gap:12px}
.logo-icon{width:44px;height:44px;background:var(--primary);border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:16px;color:#fff}
.logo h1{font-size:20px;font-weight:800;color:#fff}
.logo p{font-size:11px;color:var(--primary-light);margin-top:1px}
.header-right{display:flex;align-items:center;gap:10px}
.badge{display:inline-flex;align-items:center;gap:4px;padding:4px 12px;border-radius:20px;font-size:11px;font-weight:700}
.badge-online{background:var(--green);color:#000}
.badge-cost{background:var(--card2);color:var(--accent);border:1px solid var(--border)}

/* Main */
.main{max-width:1400px;margin:0 auto;padding:20px 24px}

/* Section */
.section{margin-bottom:24px}
.section-title{font-size:15px;font-weight:700;margin-bottom:12px;display:flex;align-items:center;gap:8px;color:var(--text)}
.section-title .icon{font-size:18px}

/* ìë™í™” ëª©ì°¨ í…Œì´ë¸” */
.auto-table{width:100%;border-collapse:separate;border-spacing:0;background:var(--card);border:1px solid var(--border);border-radius:12px;overflow:hidden}
.auto-table th{background:var(--card2);text-align:left;font-size:11px;color:var(--text3);font-weight:600;text-transform:uppercase;padding:10px 14px;border-bottom:1px solid var(--border);letter-spacing:.5px}
.auto-table td{padding:10px 14px;border-bottom:1px solid var(--border);font-size:13px;vertical-align:middle}
.auto-table tr:last-child td{border-bottom:none}
.auto-table tr[data-step].active{background:rgba(99,102,241,.08)}
.step-num{width:28px;height:28px;border-radius:8px;display:inline-flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:#fff;background:var(--border)}
.step-num.s1{background:#6366f1}.step-num.s2{background:#8b5cf6}.step-num.s3{background:#06b6d4}
.step-num.s4{background:#f59e0b}.step-num.s5{background:#ef4444}.step-num.s6{background:#22c55e}.step-num.s7{background:#3b82f6}
.step-status{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:12px;font-size:11px;font-weight:600}
.step-status.pending{background:var(--card2);color:var(--text3)}
.step-status.running{background:rgba(245,158,11,.15);color:var(--accent);animation:pulse 1.5s infinite}
.step-status.complete{background:rgba(34,197,94,.15);color:var(--green)}
.step-status.error{background:rgba(239,68,68,.15);color:var(--red)}
.step-status.skipped{background:var(--card2);color:var(--text3)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}

/* ìº í˜ì¸ ì œì–´ íŒ¨ë„ */
.campaign-panel{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px;margin-bottom:24px}
.input-row{display:flex;gap:10px;margin-bottom:14px}
.input-row input{flex:1;background:var(--card2);border:1px solid var(--border);border-radius:8px;padding:10px 16px;color:var(--text);font-size:14px;outline:none}
.input-row input:focus{border-color:var(--primary)}
.btn{padding:10px 20px;border-radius:8px;font-size:13px;font-weight:700;border:none;transition:all .2s}
.btn:hover{opacity:.85}
.btn-primary{background:var(--primary);color:#fff}
.btn-green{background:var(--green);color:#000}
.btn-outline{background:transparent;border:1px solid var(--border);color:var(--text2)}
.btn-sm{padding:6px 14px;font-size:12px}
.btn:disabled{opacity:.4;cursor:not-allowed}

/* ë¸Œëœë“œ & í”Œë«í¼ ì„ íƒ */
.selector-row{display:flex;gap:16px;flex-wrap:wrap;margin-bottom:14px}
.selector-group{display:flex;align-items:center;gap:8px}
.selector-group label{font-size:12px;color:var(--text2)}
.chip{display:inline-flex;align-items:center;gap:4px;padding:5px 12px;border-radius:8px;font-size:12px;font-weight:600;border:1px solid var(--border);background:var(--card2);color:var(--text2);cursor:pointer;transition:all .2s;user-select:none}
.chip:hover{border-color:var(--primary)}
.chip.active{border-color:var(--primary);background:rgba(99,102,241,.15);color:var(--primary-light)}
.chip.brand-active{border-color:var(--accent);background:rgba(245,158,11,.1);color:var(--accent)}
.chip .emoji{font-size:14px}

/* ì§„í–‰ë¥  ë°” */
.progress-bar{width:100%;height:6px;background:var(--card2);border-radius:3px;overflow:hidden;margin:10px 0}
.progress-bar-fill{height:100%;background:linear-gradient(90deg,var(--primary),var(--green));border-radius:3px;transition:width .5s ease;width:0%}

/* 3í”Œë«í¼ ê²°ê³¼ ê·¸ë¦¬ë“œ */
.output-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
@media(max-width:1000px){.output-grid{grid-template-columns:1fr}}
.output-card{background:var(--card);border:1px solid var(--border);border-radius:14px;overflow:hidden;display:flex;flex-direction:column}
.output-card-header{padding:14px 16px;display:flex;align-items:center;gap:8px;border-bottom:1px solid var(--border)}
.output-card-header .platform-icon{font-size:20px}
.output-card-header .platform-name{font-size:14px;font-weight:700}
.output-card-header .platform-badge{margin-left:auto;font-size:10px;padding:2px 8px;border-radius:4px;font-weight:600}
.badge-naver{background:rgba(3,199,90,.15);color:var(--naver)}
.badge-youtube{background:rgba(255,0,0,.12);color:var(--youtube)}
.badge-insta{background:rgba(228,64,95,.12);color:var(--insta)}
.output-card-body{padding:16px;flex:1;display:flex;flex-direction:column;gap:10px}
.output-field{display:flex;flex-direction:column;gap:4px}
.output-label{font-size:10px;color:var(--text3);font-weight:600;text-transform:uppercase;letter-spacing:.5px}
.output-value{font-size:13px;color:var(--text);background:var(--card2);border-radius:6px;padding:8px 10px;max-height:120px;overflow-y:auto;white-space:pre-wrap;word-break:break-word}
.output-value.title-val{font-size:14px;font-weight:600;max-height:none}
.tag-cloud{display:flex;flex-wrap:wrap;gap:4px}
.tag{padding:2px 8px;border-radius:4px;font-size:11px;background:var(--card2);color:var(--text2);border:1px solid var(--border)}
.output-card-footer{padding:12px 16px;border-top:1px solid var(--border);display:flex;gap:8px;flex-wrap:wrap}
.output-empty{text-align:center;color:var(--text3);font-size:13px;padding:40px;grid-column:1/-1}
.output-preview{width:100%;border-radius:6px;overflow:hidden;background:#000;margin-bottom:4px}
.output-preview video{width:100%;max-height:280px;display:block}
.output-preview img{width:100%;max-height:200px;object-fit:contain;display:block}

/* ë¯¸ë””ì–´ ì†ŒìŠ¤ íŒ¨ë„ */
.media-panel{background:var(--card);border:1px solid var(--border);border-radius:14px;overflow:hidden}
.media-tabs{display:flex;border-bottom:1px solid var(--border)}
.media-tab{flex:1;padding:10px;text-align:center;font-size:12px;font-weight:600;color:var(--text3);cursor:pointer;border:none;background:none;transition:all .2s}
.media-tab:hover{color:var(--text)}
.media-tab.active{color:var(--primary-light);border-bottom:2px solid var(--primary)}
.media-content{padding:16px;min-height:140px}
.media-search-row{display:flex;gap:8px;margin-bottom:12px}
.media-search-row input{flex:1;background:var(--card2);border:1px solid var(--border);border-radius:6px;padding:8px 12px;color:var(--text);font-size:13px;outline:none}
.media-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:8px}
.media-thumb{width:100%;aspect-ratio:1;object-fit:cover;border-radius:6px;cursor:pointer;border:2px solid transparent;transition:border-color .2s}
.media-thumb:hover{border-color:var(--primary)}

/* ì‹œìŠ¤í…œ ìƒíƒœ */
.status-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px}
.status-item{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:10px 12px;display:flex;align-items:center;gap:8px}
.status-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.status-dot.on{background:var(--green);box-shadow:0 0 6px rgba(34,197,94,.4)}
.status-dot.off{background:var(--text3)}
.status-name{font-size:12px;font-weight:600}
.status-detail{font-size:10px;color:var(--text3)}

/* ë¡œê·¸ íŒ¨ë„ */
.log-panel{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:12px 14px;max-height:200px;overflow-y:auto;font-family:'Cascadia Code','Fira Code',monospace;font-size:12px;color:var(--text2)}
.log-line{margin-bottom:2px;opacity:.8}
.log-line .time{color:var(--text3)}
.log-line.ok{color:var(--green)}
.log-line.err{color:var(--red)}
.log-line.warn{color:var(--accent)}

/* V2 ëª¨ë“œ ì „í™˜ */
.mode-toggle{display:flex;background:var(--card2);border-radius:10px;overflow:hidden;border:1px solid var(--border)}
.mode-btn{flex:1;padding:10px 20px;text-align:center;font-size:13px;font-weight:700;border:none;background:none;color:var(--text3);cursor:pointer;transition:all .2s}
.mode-btn:hover{color:var(--text)}
.mode-btn.active{background:var(--primary);color:#fff}
.v2-panel{display:none}
.v2-panel.visible{display:block}

/* V2 ëŒ€í™”í˜• */
.v2-chat{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px;margin-bottom:20px}
.v2-chat-header{font-size:16px;font-weight:800;margin-bottom:12px;display:flex;align-items:center;gap:8px}
.v2-state-badge{display:inline-block;padding:4px 12px;border-radius:8px;font-size:12px;font-weight:700}
.v2-state-badge.awaiting{background:rgba(99,102,241,.15);color:var(--primary-light)}
.v2-state-badge.analyzing{background:rgba(245,158,11,.15);color:var(--accent);animation:pulse 1.5s infinite}
.v2-state-badge.confirm{background:rgba(34,197,94,.15);color:var(--green)}
.v2-state-badge.executing{background:rgba(239,68,68,.15);color:var(--red);animation:pulse 1.5s infinite}
.v2-state-badge.complete{background:rgba(34,197,94,.15);color:var(--green)}
.v2-link-input{display:flex;gap:10px;margin-top:12px}
.v2-link-input input{flex:1;background:var(--card2);border:1px solid var(--border);border-radius:8px;padding:12px 16px;color:var(--text);font-size:14px;outline:none}
.v2-link-input input:focus{border-color:var(--primary)}
.v2-product-card{background:var(--card2);border-radius:10px;padding:14px;margin-top:12px}
.v2-product-card h3{font-size:15px;margin-bottom:6px}
.v2-product-card p{font-size:12px;color:var(--text2)}

/* V2 ë¯¸ë¦¬ë³´ê¸° ê·¸ë¦¬ë“œ */
.v2-preview-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px}
@media(max-width:900px){.v2-preview-grid{grid-template-columns:1fr}}
.v2-preview-panel{background:var(--card);border:1px solid var(--border);border-radius:12px;overflow:hidden}
.v2-preview-header{padding:10px 14px;font-size:13px;font-weight:700;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:6px}
.v2-preview-body{padding:14px;max-height:300px;overflow-y:auto;font-size:13px;color:var(--text2);white-space:pre-wrap;word-break:break-word}
.v2-preview-body iframe{width:100%;height:250px;border:none;border-radius:6px}

/* V2 10ë‹¨ê³„ */
.step-num.s8{background:#ec4899}.step-num.s9{background:#14b8a6}.step-num.s10{background:#f97316}

/* Footer */
.footer{text-align:center;padding:24px;color:var(--text3);font-size:11px;border-top:1px solid var(--border);margin-top:32px}

/* ë°˜ì‘í˜• */
@media(max-width:768px){
  .output-grid{grid-template-columns:1fr}
  .selector-row{flex-direction:column}
}
</style>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;700;800&display=swap" rel="stylesheet">
</head>
<body>

<!-- Header -->
<header class="header">
  <div class="header-inner">
    <div class="logo">
      <div class="logo-icon">YJ</div>
      <div>
        <h1>YJ MCN Automation Hub</h1>
        <p>3-Platform Content Factory</p>
      </div>
    </div>
    <div class="header-right">
      <span class="badge badge-cost" id="cost-badge">API Cost: â‚©0</span>
      <span class="badge badge-online" id="status-badge">CONNECTING...</span>
    </div>
  </div>
</header>

<main class="main">

  <!-- V1/V2 ëª¨ë“œ ì „í™˜ -->
  <div class="section" style="margin-bottom:16px">
    <div class="mode-toggle">
      <button class="mode-btn active" id="mode-v1-btn" onclick="switchMode('v1')">V1 â€” ê¸°ì¡´ íŒŒì´í”„ë¼ì¸ (7ë‹¨ê³„)</button>
      <button class="mode-btn" id="mode-v2-btn" onclick="switchMode('v2')">ğŸ”¥ V2 â€” ì¿ íŒ¡ ìˆ˜ìµ ê·¹ëŒ€í™” (10ë‹¨ê³„)</button>
    </div>
  </div>

  <!-- â•â•â• V2 ëŒ€í™”í˜• íŒ¨ë„ â•â•â• -->
  <div class="v2-panel" id="v2-panel">
    <!-- V2 ëŒ€í™”í˜• UI -->
    <div class="v2-chat" id="v2-chat">
      <div class="v2-chat-header">
        ğŸ›’ Coupang Profit Maximizer V2
        <span class="v2-state-badge awaiting" id="v2-state-badge">ë§í¬ ì…ë ¥ ëŒ€ê¸°</span>
      </div>
      <p style="font-size:13px;color:var(--text2);margin-bottom:8px">ìƒí’ˆì •ë³´ ë§í¬ë¡œ ìƒí’ˆ ë¶„ì„ â†’ AI ì½˜í…ì¸  ìƒì„± â†’ ìˆ˜ìµ ë§í¬ ìë™ ì‚½ì… â†’ 3ê°œ í”Œë«í¼ ì½˜í…ì¸  ìƒì„±</p>
      <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px" id="v2-link-section">
        <div style="display:flex;align-items:center;gap:8px">
          <span style="min-width:100px;font-size:12px;font-weight:700;color:var(--accent)">ğŸ“¦ ìƒí’ˆì •ë³´</span>
          <input type="text" id="v2-product-url" placeholder="coupang.com/vp/products/... (ìƒí’ˆ í˜ì´ì§€ URL)" style="flex:1;background:var(--card2);border:1px solid var(--border);border-radius:8px;padding:10px 14px;color:var(--text);font-size:13px;outline:none" />
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          <span style="min-width:100px;font-size:12px;font-weight:700;color:var(--green)">ğŸ’° ë‹¨ì¶• URL</span>
          <input type="text" id="v2-affiliate-url" placeholder="https://link.coupang.com/a/... (íŒŒíŠ¸ë„ˆìŠ¤ ìˆ˜ìµ ë§í¬)" style="flex:1;background:var(--card2);border:1px solid var(--border);border-radius:8px;padding:10px 14px;color:var(--text);font-size:13px;outline:none" />
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          <span style="min-width:100px;font-size:12px;font-weight:700;color:var(--blue)">ğŸ–¼ï¸ iframe</span>
          <input type="text" id="v2-iframe-tag" placeholder='<iframe src="https://coupa.ng/..." ...> (ë¸”ë¡œê·¸ ìƒí’ˆìœ„ì ¯)' style="flex:1;background:var(--card2);border:1px solid var(--border);border-radius:8px;padding:10px 14px;color:var(--text);font-size:13px;outline:none" />
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          <span style="min-width:100px;font-size:12px;font-weight:700;color:var(--text3)">ğŸ·ï¸ ìƒí’ˆëª…</span>
          <input type="text" id="v2-product-name" placeholder="(ì„ íƒ) ìƒí’ˆëª… ì§ì ‘ ì…ë ¥ â€” ìŠ¤í¬ë˜í•‘ ì‹¤íŒ¨ ì‹œ ì‚¬ìš©" style="flex:1;background:var(--card2);border:1px solid var(--border);border-radius:8px;padding:10px 14px;color:var(--text);font-size:13px;outline:none" />
          <button class="btn btn-primary" id="v2-btn-submit" onclick="v2SubmitLink()" style="padding:10px 20px;white-space:nowrap">ğŸ” ë¶„ì„ ì‹œì‘</button>
        </div>
        <div style="font-size:11px;color:var(--text3);padding:4px 0 0 108px">
          âš ï¸ "ì´ í¬ìŠ¤íŒ…ì€ ì¿ íŒ¡ íŒŒíŠ¸ë„ˆìŠ¤ í™œë™ì˜ ì¼í™˜ìœ¼ë¡œ, ì´ì— ë”°ë¥¸ ì¼ì •ì•¡ì˜ ìˆ˜ìˆ˜ë£Œë¥¼ ì œê³µë°›ìŠµë‹ˆë‹¤." â€” ëª¨ë“  ì½˜í…ì¸ ì— ìë™ ì‚½ì…
        </div>
      </div>
      <!-- ìƒí’ˆ ë¶„ì„ ê²°ê³¼ -->
      <div id="v2-product-area" style="display:none"></div>
      <!-- ì‹¤í–‰ ë²„íŠ¼ -->
      <div id="v2-confirm-area" style="display:none;margin-top:12px">
        <button class="btn btn-green" id="v2-btn-confirm" onclick="v2Confirm()" style="width:100%;padding:14px;font-size:15px">ğŸš€ V2 íŒŒì´í”„ë¼ì¸ ì‹¤í–‰!</button>
      </div>
    </div>

    <!-- V2 10ë‹¨ê³„ íŒŒì´í”„ë¼ì¸ í…Œì´ë¸” -->
    <div class="section">
      <div class="section-title"><span class="icon">ğŸ“‹</span> V2 íŒŒì´í”„ë¼ì¸ (10ë‹¨ê³„)</div>
      <table class="auto-table" id="v2-auto-table">
        <thead>
          <tr>
            <th style="width:50px">Step</th>
            <th>í”„ë¡œì„¸ìŠ¤</th>
            <th>ëª¨ë“ˆ</th>
            <th style="width:100px">Status</th>
          </tr>
        </thead>
        <tbody>
          <tr data-v2step="1"><td><span class="step-num s1">1</span></td><td><b>ì¤€ë¹„ ë¦¬í¬íŠ¸</b></td><td>pipeline</td><td><span class="step-status pending" id="v2-step-1">â¸ ëŒ€ê¸°</span></td></tr>
          <tr data-v2step="2"><td><span class="step-num s2">2</span></td><td><b>ì¿ íŒ¡ ë§í¬ ë¶„ì„</b></td><td>coupang_scraper</td><td><span class="step-status pending" id="v2-step-2">â¸ ëŒ€ê¸°</span></td></tr>
          <tr data-v2step="3"><td><span class="step-num s3">3</span></td><td><b>AI ì½˜í…ì¸  ìƒì„±</b><br><small style="color:var(--text3)">ë¸”ë¡œê·¸ + ìˆí¼ ëŒ€ë³¸ (Gemini ë¬´ë£Œ)</small></td><td>ai_generator V2</td><td><span class="step-status pending" id="v2-step-3">â¸ ëŒ€ê¸°</span></td></tr>
          <tr data-v2step="4"><td><span class="step-num s3">4</span></td><td><b>ë¯¸ë””ì–´ í¬ë¡¤ë§</b><br><small style="color:var(--text3)">ë¸”ë¡œê·¸ ì´ë¯¸ì§€ + ìˆí¼ ì˜ìƒ</small></td><td>OmniMediaCollector</td><td><span class="step-status pending" id="v2-step-4">â¸ ëŒ€ê¸°</span></td></tr>
          <tr data-v2step="5"><td><span class="step-num s4">5</span></td><td><b>ë¸”ë¡œê·¸ HTML ì¡°ë¦½</b><br><small style="color:var(--text3)">ì´ë¯¸ì§€-í…ìŠ¤íŠ¸ êµì°¨ + CTA</small></td><td>blog_html_generator</td><td><span class="step-status pending" id="v2-step-5">â¸ ëŒ€ê¸°</span></td></tr>
          <tr data-v2step="6"><td><span class="step-num s5">6</span></td><td><b>4ë‹¨ê³„ ì˜ìƒ ì„¸íƒ</b><br><small style="color:var(--text3)">Cropâ†’Muteâ†’Speedâ†’Sharpen (FFmpeg GPU)</small></td><td>video_launderer</td><td><span class="step-status pending" id="v2-step-6">â¸ ëŒ€ê¸°</span></td></tr>
          <tr data-v2step="7"><td><span class="step-num s5">7</span></td><td><b>ìˆí¼ ë Œë”ë§</b><br><small style="color:var(--text3)">TTS + Whisper ìë§‰ ì‹±í¬</small></td><td>ShortsRenderer</td><td><span class="step-status pending" id="v2-step-7">â¸ ëŒ€ê¸°</span></td></tr>
          <tr data-v2step="8"><td><span class="step-num s8">8</span></td><td><b>ì¸ë„¤ì¼ ìƒì„±</b></td><td>thumbnail_generator</td><td><span class="step-status pending" id="v2-step-8">â¸ ëŒ€ê¸°</span></td></tr>
          <tr data-v2step="9"><td><span class="step-num s9">9</span></td><td><b>ì—…ë¡œë“œ ì¤€ë¹„</b><br><small style="color:var(--text3)">ì¿ íŒ¡ ë§í¬ ìë™ ë°°ì¹˜</small></td><td>auto_uploader V2</td><td><span class="step-status pending" id="v2-step-9">â¸ ëŒ€ê¸°</span></td></tr>
          <tr data-v2step="10"><td><span class="step-num s10">10</span></td><td><b>Drive ì•„ì¹´ì´ë¹™</b></td><td>drive_manager</td><td><span class="step-status pending" id="v2-step-10">â¸ ëŒ€ê¸°</span></td></tr>
        </tbody>
      </table>
      <div class="progress-bar"><div class="progress-bar-fill" id="v2-pipeline-progress"></div></div>
    </div>

    <!-- V2 ë¸”ë¡œê·¸/ìˆí¼ ë¯¸ë¦¬ë³´ê¸° -->
    <div class="v2-preview-grid" id="v2-preview-grid" style="display:none">
      <div class="v2-preview-panel">
        <div class="v2-preview-header">ğŸ“— ë¸”ë¡œê·¸ ë¯¸ë¦¬ë³´ê¸°</div>
        <div class="v2-preview-body" id="v2-blog-preview">ë¸”ë¡œê·¸ HTMLì´ ìƒì„±ë˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
      </div>
      <div class="v2-preview-panel">
        <div class="v2-preview-header">ğŸ¬ ìˆí¼ ëŒ€ë³¸ ë¯¸ë¦¬ë³´ê¸°</div>
        <div class="v2-preview-body" id="v2-shorts-preview">ìˆí¼ ëŒ€ë³¸ì´ ìƒì„±ë˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
      </div>
    </div>
  </div>

  <!-- â•â•â• V1 ê¸°ì¡´ íŒ¨ë„ (ê¸°ë³¸ í‘œì‹œ) â•â•â• -->
  <div id="v1-panel">

  <!-- ìë™í™” ëª©ì°¨ í…Œì´ë¸” -->
  <div class="section">
    <div class="section-title"><span class="icon">ğŸ“‹</span> ìë™í™” íŒŒì´í”„ë¼ì¸ (ëª©ì°¨)</div>
    <table class="auto-table" id="auto-table">
      <thead>
        <tr>
          <th style="width:50px">Step</th>
          <th>í”„ë¡œì„¸ìŠ¤</th>
          <th>ëª¨ë“ˆ</th>
          <th>Input</th>
          <th>Output</th>
          <th style="width:100px">Status</th>
        </tr>
      </thead>
      <tbody>
        <tr data-step="1">
          <td><span class="step-num s1">1</span></td>
          <td><b>ìƒí’ˆ ìŠ¤í¬ë˜í•‘ / ì£¼ì œ íŒŒì‹±</b></td>
          <td>coupang_scraper / pipeline</td>
          <td>URL ë˜ëŠ” ì£¼ì œ í…ìŠ¤íŠ¸</td>
          <td>Product ê°ì²´ (ì œëª©, ê°€ê²©, ì´ë¯¸ì§€, ì œíœ´ë§í¬)</td>
          <td><span class="step-status pending" id="step-1">â¸ ëŒ€ê¸°</span></td>
        </tr>
        <tr data-step="2">
          <td><span class="step-num s2">2</span></td>
          <td><b>AI ì½˜í…ì¸  ìƒì„±</b><br><small style="color:var(--text3)">Gemini(ë¬´ë£Œ) + Claude(ìœ ë£Œ)</small></td>
          <td>ai_generator</td>
          <td>Product ë°ì´í„°</td>
          <td>ì œëª©, ë³¸ë¬¸, í•´ì‹œíƒœê·¸, ë‚˜ë ˆì´ì…˜ Ã—3</td>
          <td><span class="step-status pending" id="step-2">â¸ ëŒ€ê¸°</span></td>
        </tr>
        <tr data-step="3">
          <td><span class="step-num s3">3</span></td>
          <td><b>ë¯¸ë””ì–´ ìˆ˜ì§‘</b><br><small style="color:var(--text3)">Pexels+Pixabay+Unsplash+yt-dlp</small></td>
          <td>media_collector</td>
          <td>ê²€ìƒ‰ í‚¤ì›Œë“œ</td>
          <td>ì´ë¯¸ì§€ 5-8ê°œ + ìŠ¤í†¡ ì˜ìƒ</td>
          <td><span class="step-status pending" id="step-3">â¸ ëŒ€ê¸°</span></td>
        </tr>
        <tr data-step="4">
          <td><span class="step-num s4">4</span></td>
          <td><b>ì¸ë„¤ì¼ ìƒì„±</b></td>
          <td>thumbnail_generator (Pillow)</td>
          <td>ì´ë¯¸ì§€ + AI í…ìŠ¤íŠ¸ + ë¸Œëœë“œ</td>
          <td>í”Œë«í¼ë³„ ì¸ë„¤ì¼ 3ê°œ (JPEG)</td>
          <td><span class="step-status pending" id="step-4">â¸ ëŒ€ê¸°</span></td>
        </tr>
        <tr data-step="5">
          <td><span class="step-num s5">5</span></td>
          <td><b>ì˜ìƒ ë Œë”ë§</b><br><small style="color:var(--text3)">MoviePy + Edge-TTS</small></td>
          <td>video_editor / VideoForge</td>
          <td>ì´ë¯¸ì§€ + ë‚˜ë ˆì´ì…˜ + ì„¤ì •</td>
          <td>MP4 ì˜ìƒ 3ê°œ (1080Ã—1920)</td>
          <td><span class="step-status pending" id="step-5">â¸ ëŒ€ê¸°</span></td>
        </tr>
        <tr data-step="6">
          <td><span class="step-num s6">6</span></td>
          <td><b>ìë™ ì—…ë¡œë“œ / ë°œí–‰</b></td>
          <td>auto_uploader</td>
          <td>ì˜ìƒ + ì½˜í…ì¸  + ì¸ë„¤ì¼</td>
          <td>ë°œí–‰ URL (YouTube, Naver, Instagram)</td>
          <td><span class="step-status pending" id="step-6">â¸ ëŒ€ê¸°</span></td>
        </tr>
        <tr data-step="7">
          <td><span class="step-num s7">7</span></td>
          <td><b>Google Drive ì•„ì¹´ì´ë¹™</b><br><small style="color:var(--text3)">ìë™ í´ë” ìƒì„± + ë¶„ë¥˜ ì—…ë¡œë“œ</small></td>
          <td>drive_manager</td>
          <td>ì˜ìƒ + ì¸ë„¤ì¼ + ì´ë¯¸ì§€ + ì˜¤ë””ì˜¤</td>
          <td>Drive í´ë” URL (ì›”ë³„/ìº í˜ì¸ë³„ ìë™ ë¶„ë¥˜)</td>
          <td><span class="step-status pending" id="step-7">â¸ ëŒ€ê¸°</span></td>
        </tr>
      </tbody>
    </table>
    <div class="progress-bar"><div class="progress-bar-fill" id="pipeline-progress"></div></div>
  </div>

  <!-- ìº í˜ì¸ ì œì–´ íŒ¨ë„ -->
  <div class="campaign-panel">
    <div class="input-row">
      <input type="text" id="topic-input" placeholder="ì¿ íŒ¡ URL, ì£¼ì œ í…ìŠ¤íŠ¸, ë˜ëŠ” ì†Œì…œ ë¯¸ë””ì–´ URL ì…ë ¥..." />
      <button class="btn btn-primary" id="btn-start" onclick="startPipeline()">ğŸš€ íŒŒì´í”„ë¼ì¸ ì‹œì‘</button>
      <button class="btn btn-outline" id="btn-content-only" onclick="generateContentOnly()">ğŸ“ ì½˜í…ì¸ ë§Œ</button>
    </div>
    <div class="selector-row">
      <div class="selector-group">
        <label>ë¸Œëœë“œ:</label>
        <span class="chip brand-chip" data-brand="" onclick="selectBrand(this)">ì—†ìŒ</span>
        <span class="chip brand-chip" data-brand="ì˜¤ë ˆë…¸ì¹´ì¸ " onclick="selectBrand(this)"><span class="emoji">ğŸ±</span> ì˜¤ë ˆë…¸ì¹´ì¸ </span>
        <span class="chip brand-chip" data-brand="ë¬´ì‚¬ì§¬ë½•" onclick="selectBrand(this)"><span class="emoji">ğŸœ</span> ë¬´ì‚¬ì§¬ë½•</span>
        <span class="chip brand-chip" data-brand="ë¸Œë¦¿ì§€ì›" onclick="selectBrand(this)"><span class="emoji">ğŸ’¼</span> ë¸Œë¦¿ì§€ì›</span>
      </div>
      <div class="selector-group">
        <label>í”Œë«í¼:</label>
        <span class="chip platform-chip active" data-platform="naver_blog" onclick="togglePlatform(this)"><span class="emoji">ğŸ“—</span> ë„¤ì´ë²„ ë¸”ë¡œê·¸</span>
        <span class="chip platform-chip active" data-platform="instagram" onclick="togglePlatform(this)"><span class="emoji">ğŸ“¸</span> ì¸ìŠ¤íƒ€ê·¸ë¨ ë¦´ìŠ¤</span>
        <span class="chip platform-chip active" data-platform="youtube" onclick="togglePlatform(this)"><span class="emoji">â–¶ï¸</span> ìœ íŠœë¸Œ ì‡¼ì¸ </span>
      </div>
      <div class="selector-group">
        <label>AI:</label>
        <select id="ai-provider" style="background:var(--card2);border:1px solid var(--border);border-radius:6px;padding:4px 8px;color:var(--text);font-size:12px">
          <option value="">ìë™ (ë¬´ë£Œ ìš°ì„ )</option>
          <option value="ollama">Ollama ë¡œì»¬ (ë¬´ë£Œ)</option>
          <option value="gemini">Gemini Flash (ë¬´ë£Œ)</option>
          <option value="gemini_pro">Gemini Pro (ë¬´ë£Œ)</option>
          <option value="claude_haiku">Claude Haiku (ì €ê°€)</option>
          <option value="openai_mini">GPT-4o-mini (ì €ê°€)</option>
          <option value="openai">GPT-4o (ì¤‘ê°€)</option>
          <option value="claude_sonnet">Claude Sonnet (ê³ ê°€)</option>
        </select>
      </div>
      <div class="selector-group">
        <label><input type="checkbox" id="auto-upload"> ìë™ ì—…ë¡œë“œ</label>
      </div>
      <div class="selector-group">
        <label><input type="checkbox" id="drive-archive" checked> â˜ï¸ Drive ì•„ì¹´ì´ë¹™</label>
      </div>
    </div>
  </div>

  <!-- 3í”Œë«í¼ ê²°ê³¼ ë¯¸ë¦¬ë³´ê¸° -->
  <div class="section">
    <div class="section-title"><span class="icon">ğŸ“Š</span> 3í”Œë«í¼ ê²°ê³¼ ë¯¸ë¦¬ë³´ê¸°</div>
    <div class="output-grid" id="output-grid">
      <div class="output-empty">íŒŒì´í”„ë¼ì¸ì„ ì‹¤í–‰í•˜ë©´ 3ê°œ í”Œë«í¼ë³„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</div>
    </div>
  </div>

  <!-- ë¯¸ë””ì–´ ì†ŒìŠ¤ íŒ¨ë„ -->
  <div class="section">
    <div class="section-title"><span class="icon">ğŸ–¼ï¸</span> ë¯¸ë””ì–´ ì†ŒìŠ¤</div>
    <div class="media-panel">
      <div class="media-tabs">
        <button class="media-tab active" onclick="switchMediaTab('stock',this)">ğŸ“· ë¬´ë£Œ ìŠ¤í†¡</button>
        <button class="media-tab" onclick="switchMediaTab('social',this)">ğŸµ ì†Œì…œ ì¶”ì¶œ</button>
        <button class="media-tab" onclick="switchMediaTab('ai',this)">ğŸ¤– AI ìƒì„±</button>
      </div>
      <div class="media-content" id="media-content">
        <div class="media-search-row">
          <input type="text" id="media-query" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥ (ì˜ˆ: ëˆì¹´ì¸ , í”„ëœì°¨ì´ì¦ˆ)" />
          <button class="btn btn-sm btn-primary" onclick="searchMedia()">ê²€ìƒ‰</button>
        </div>
        <div class="media-grid" id="media-results"></div>
      </div>
    </div>
  </div>

  <!-- ìº í˜ì¸ íˆìŠ¤í† ë¦¬ -->
  <div class="section">
    <div class="section-title"><span class="icon">ğŸ“‚</span> ìº í˜ì¸ íˆìŠ¤í† ë¦¬ <button class="btn btn-sm btn-outline" onclick="loadHistory()" style="margin-left:8px">ìƒˆë¡œê³ ì¹¨</button></div>
    <div id="history-panel" style="max-height:200px;overflow-y:auto">
      <table class="auto-table" id="history-table">
        <thead><tr><th>ID</th><th>ì£¼ì œ</th><th>ë¸Œëœë“œ</th><th>í”Œë«í¼</th><th>ìƒíƒœ</th><th>ë¹„ìš©</th><th>ë‚ ì§œ</th><th></th></tr></thead>
        <tbody id="history-body"><tr><td colspan="8" style="text-align:center;color:var(--text3)">ë¡œë”© ì¤‘...</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- ì‹¤í–‰ ë¡œê·¸ -->
  <div class="section">
    <div class="section-title"><span class="icon">ğŸ“œ</span> ì‹¤í–‰ ë¡œê·¸</div>
    <div class="log-panel" id="log-panel">
      <div class="log-line"><span class="time">[--:--:--]</span> ì‹œìŠ¤í…œ ëŒ€ê¸° ì¤‘... íŒŒì´í”„ë¼ì¸ì„ ì‹œì‘í•˜ì„¸ìš”.</div>
    </div>
  </div>

  <!-- ì‹œìŠ¤í…œ ìƒíƒœ -->
  <div class="section">
    <div class="section-title"><span class="icon">ğŸ”Œ</span> ì—°ê²° ì„œë¹„ìŠ¤</div>
    <div class="status-grid" id="status-grid"></div>
  </div>

  </div><!-- /v1-panel -->

</main>

<footer class="footer">
  &copy; 2026 YJ Partners MCN. Powered by Gemini AI + Claude AI + FFmpeg GPU + Edge-TTS + Whisper<br>
  V1: 7-Step Pipeline | V2: 10-Step Coupang Profit Maximizer | Backend: Flask (5001) | Frontend: Vanilla JS + SSE
</footer>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ìƒíƒœ ê´€ë¦¬
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const API = '';  // ê°™ì€ í˜¸ìŠ¤íŠ¸
let currentJob = null;
let eventSource = null;
let selectedBrand = '';
let currentMediaTab = 'stock';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ì´ˆê¸°í™”
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('DOMContentLoaded', () => {
  checkHealth();
  loadHistory();
  updateCostBadge();
  setInterval(checkHealth, 30000);
  setInterval(updateCostBadge, 60000);  // 1ë¶„ë§ˆë‹¤ ë¹„ìš© ì—…ë°ì´íŠ¸
  // ê¸°ë³¸ ë¸Œëœë“œ = ì—†ìŒ
  document.querySelector('.brand-chip[data-brand=""]').classList.add('brand-active');
});

async function checkHealth() {
  try {
    const resp = await fetch(API + '/api/health');
    const data = await resp.json();
    document.getElementById('status-badge').textContent = 'ONLINE ' + new Date().toLocaleTimeString('ko-KR', {hour:'2-digit',minute:'2-digit'});
    document.getElementById('status-badge').className = 'badge badge-online';
    renderServices(data.services);
  } catch(e) {
    document.getElementById('status-badge').textContent = 'OFFLINE';
    document.getElementById('status-badge').className = 'badge';
    document.getElementById('status-badge').style.cssText = 'background:var(--red);color:#fff';
  }
}

function renderServices(services) {
  const grid = document.getElementById('status-grid');
  const svcNames = {
    ollama: ['Ollama llama3.1', 'ë¡œì»¬ ë¬´ë£Œ AI'],
    gemini: ['Gemini Flash', 'ë¬´ë£Œ AI'],
    gemini_pro: ['Gemini Pro', 'ë¬´ë£Œ ìš¸íŠ¸ë¼ê¸‰'],
    claude_haiku: ['Claude Haiku', 'ì €ê°€ API'],
    openai_mini: ['GPT-4o-mini', 'ì €ê°€ API'],
    openai: ['GPT-4o', 'ì¤‘ê°€ API'],
    claude_sonnet: ['Claude Sonnet', 'ê³ ê°€ API'],
    openai_o1: ['OpenAI o1', 'ê³ ê°€ API'],
    pexels: ['Pexels', 'ë¬´ë£Œ ìŠ¤í†¡'],
    pixabay: ['Pixabay', 'ë¬´ë£Œ ìŠ¤í†¡'],
    unsplash: ['Unsplash', 'ë¬´ë£Œ ìŠ¤í†¡'],
    openclaw: ['OpenClaw', 'í…”ë ˆê·¸ë¨ ë´‡'],
  };
  grid.innerHTML = Object.entries(services).map(([key, ok]) =>
    `<div class="status-item">
      <div class="status-dot ${ok?'on':'off'}"></div>
      <div><div class="status-name">${svcNames[key]?.[0]||key}</div><div class="status-detail">${svcNames[key]?.[1]||''}</div></div>
    </div>`
  ).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ë¸Œëœë“œ / í”Œë«í¼ ì„ íƒ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function selectBrand(el) {
  document.querySelectorAll('.brand-chip').forEach(c => c.classList.remove('brand-active'));
  el.classList.add('brand-active');
  selectedBrand = el.dataset.brand;
}

function togglePlatform(el) {
  el.classList.toggle('active');
}

function getSelectedPlatforms() {
  return [...document.querySelectorAll('.platform-chip.active')].map(el => el.dataset.platform);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// íŒŒì´í”„ë¼ì¸ ì‹œì‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function startPipeline() {
  const topic = document.getElementById('topic-input').value.trim();
  if (!topic) { alert('ì£¼ì œ ë˜ëŠ” URLì„ ì…ë ¥í•˜ì„¸ìš”'); return; }

  const platforms = getSelectedPlatforms();
  if (!platforms.length) { alert('í”Œë«í¼ì„ 1ê°œ ì´ìƒ ì„ íƒí•˜ì„¸ìš”'); return; }

  const autoUpload = document.getElementById('auto-upload').checked;
  const driveArchive = document.getElementById('drive-archive').checked;

  // UI ë¦¬ì…‹
  resetSteps();
  clearLog();
  document.getElementById('output-grid').innerHTML = '<div class="output-empty">íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ì¤‘...</div>';
  document.getElementById('btn-start').disabled = true;

  addLog('íŒŒì´í”„ë¼ì¸ ì‹œì‘: ' + topic, 'ok');
  addLog('ë¸Œëœë“œ: ' + (selectedBrand || 'ì—†ìŒ') + ' | í”Œë«í¼: ' + platforms.join(', '));

  try {
    const resp = await fetch(API + '/api/campaign/start', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        topic,
        brand: selectedBrand,
        platforms,
        persona: '',
        auto_upload: autoUpload,
        drive_archive: driveArchive,
      }),
    });
    const data = await resp.json();
    if (data.error) { addLog('ì˜¤ë¥˜: ' + data.error, 'err'); return; }

    currentJob = data.job_id;
    addLog('Job ID: ' + currentJob);

    // SSE ì—°ê²°
    if (eventSource) eventSource.close();
    eventSource = new EventSource(API + '/api/campaign/stream/' + currentJob);
    eventSource.onmessage = (e) => handleSSE(JSON.parse(e.data));
    eventSource.onerror = () => {
      addLog('SSE ì—°ê²° ì¢…ë£Œ', 'warn');
      eventSource.close();
      document.getElementById('btn-start').disabled = false;
    };
  } catch(e) {
    addLog('ì„œë²„ ì—°ê²° ì‹¤íŒ¨: ' + e.message, 'err');
    document.getElementById('btn-start').disabled = false;
  }
}

function handleSSE(msg) {
  if (msg.type === 'step') {
    updateStep(msg.step, msg.status, msg.detail);
    const totalSteps = 7;
    const progress = Math.min((msg.step / totalSteps) * 100, 100);
    document.getElementById('pipeline-progress').style.width = progress + '%';
    addLog(`[Step ${msg.step}] ${msg.name}: ${msg.detail}`, msg.status === 'error' ? 'err' : 'ok');
  }
  if (msg.type === 'complete' || msg.type === 'done') {
    const results = msg.results;
    if (results) {
      renderOutputCards(results);
      // Drive URL í‘œì‹œ
      if (results.drive_url) {
        addLog('ğŸ“ Google Drive: ' + results.drive_url, 'ok');
        showDriveLink(results.drive_url, results.drive_files_uploaded || 0);
      }
    }
    document.getElementById('pipeline-progress').style.width = '100%';
    addLog('ğŸ‰ íŒŒì´í”„ë¼ì¸ ì™„ë£Œ! (7ë‹¨ê³„ ì „ì²´)', 'ok');
    document.getElementById('btn-start').disabled = false;
    if (eventSource) eventSource.close();
  }
  if (msg.type === 'error') {
    addLog('íŒŒì´í”„ë¼ì¸ ì˜¤ë¥˜: ' + msg.error, 'err');
    document.getElementById('btn-start').disabled = false;
    if (eventSource) eventSource.close();
  }
}

function showDriveLink(url, fileCount) {
  const grid = document.getElementById('output-grid');
  const driveCard = document.createElement('div');
  driveCard.style.cssText = 'grid-column:1/-1;background:var(--card);border:1px solid var(--blue);border-radius:14px;padding:16px;display:flex;align-items:center;gap:12px';
  driveCard.innerHTML = `
    <span style="font-size:32px">â˜ï¸</span>
    <div style="flex:1">
      <div style="font-size:14px;font-weight:700;color:var(--blue)">Google Drive ì•„ì¹´ì´ë¹™ ì™„ë£Œ</div>
      <div style="font-size:12px;color:var(--text2);margin-top:2px">${fileCount}ê°œ íŒŒì¼ ìë™ ë¶„ë¥˜ ì—…ë¡œë“œ (ì˜ìƒ/ì¸ë„¤ì¼/ì´ë¯¸ì§€/ì˜¤ë””ì˜¤)</div>
    </div>
    <a href="${escHtml(url)}" target="_blank" class="btn btn-sm" style="background:var(--blue);color:#fff">ğŸ“‚ Drive í´ë” ì—´ê¸°</a>
  `;
  grid.appendChild(driveCard);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ì½˜í…ì¸ ë§Œ ìƒì„± (ì˜ìƒ ì—†ì´)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function generateContentOnly() {
  const topic = document.getElementById('topic-input').value.trim();
  if (!topic) { alert('ì£¼ì œ ë˜ëŠ” URLì„ ì…ë ¥í•˜ì„¸ìš”'); return; }

  const platforms = getSelectedPlatforms();
  document.getElementById('btn-content-only').disabled = true;
  addLog('AI ì½˜í…ì¸  ìƒì„± ì‹œì‘ (ì˜ìƒ ì œì™¸): ' + topic, 'ok');

  try {
    const resp = await fetch(API + '/api/content/generate', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ topic, brand: selectedBrand, platforms }),
    });
    const data = await resp.json();
    if (data.error) { addLog('ì˜¤ë¥˜: ' + data.error, 'err'); return; }

    // ê²°ê³¼ë¥¼ output cards í˜•ì‹ìœ¼ë¡œ ë³€í™˜
    const results = { platforms: {} };
    for (const [pName, content] of Object.entries(data.contents || {})) {
      results.platforms[pName] = { content, video: null, thumbnail: null };
    }
    renderOutputCards(results);
    addLog('AI ì½˜í…ì¸  ìƒì„± ì™„ë£Œ', 'ok');
  } catch(e) {
    addLog('ì˜¤ë¥˜: ' + e.message, 'err');
  } finally {
    document.getElementById('btn-content-only').disabled = false;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ë‹¨ê³„ ìƒíƒœ ì—…ë°ì´íŠ¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateStep(step, status, detail) {
  const el = document.getElementById('step-' + step);
  if (!el) return;
  const icons = {pending:'â¸',running:'ğŸ”„',complete:'âœ…',error:'âŒ',skipped:'â­'};
  const labels = {pending:'ëŒ€ê¸°',running:'ì‹¤í–‰ ì¤‘',complete:'ì™„ë£Œ',error:'ì˜¤ë¥˜',skipped:'ê±´ë„ˆëœ€'};
  el.className = 'step-status ' + status;
  el.textContent = (icons[status]||'') + ' ' + (labels[status]||status);
  // í™œì„± í–‰ í•˜ì´ë¼ì´íŠ¸
  document.querySelectorAll('#auto-table tr[data-step]').forEach(tr => tr.classList.remove('active'));
  if (status === 'running') {
    const row = document.querySelector(`#auto-table tr[data-step="${step}"]`);
    if (row) row.classList.add('active');
  }
}

function resetSteps() {
  for (let i = 1; i <= 7; i++) updateStep(i, 'pending', '');
  document.getElementById('pipeline-progress').style.width = '0%';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 3í”Œë«í¼ ê²°ê³¼ ì¹´ë“œ ë Œë”ë§
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderOutputCards(results) {
  const grid = document.getElementById('output-grid');
  const platformConfigs = {
    naver_blog: { icon: 'ğŸ“—', name: 'ë„¤ì´ë²„ ë¸”ë¡œê·¸', badge: 'badge-naver', badgeText: 'Blog' },
    instagram: { icon: 'ğŸ“¸', name: 'ì¸ìŠ¤íƒ€ê·¸ë¨ ë¦´ìŠ¤', badge: 'badge-insta', badgeText: 'Reels' },
    youtube: { icon: 'â–¶ï¸', name: 'ìœ íŠœë¸Œ ì‡¼ì¸ ', badge: 'badge-youtube', badgeText: 'Shorts' },
  };

  let html = '';
  for (const [pName, pData] of Object.entries(results.platforms || {})) {
    const cfg = platformConfigs[pName];
    if (!cfg) continue;
    const content = pData.content || {};

    // í•´ì‹œíƒœê·¸ ë Œë”ë§
    const hashtags = (content.hashtags || []);
    const tagHtml = hashtags.map(t => `<span class="tag">${t}</span>`).join('');

    // ë¯¸ë””ì–´ ìƒíƒœ
    const hasVideo = pData.video && pData.video !== 'None' && pData.video !== '';
    const hasThumbnail = pData.thumbnail && pData.thumbnail !== 'None' && pData.thumbnail !== '';
    const videoUrl = hasVideo ? `/api/file/${pData.video}` : '';
    const thumbUrl = hasThumbnail ? `/api/file/${pData.thumbnail}` : '';

    // ë¯¸ë””ì–´ ë¯¸ë¦¬ë³´ê¸° HTML
    let previewHtml = '';
    if (hasVideo) {
      previewHtml = `<div class="output-preview"><video src="${videoUrl}" controls preload="metadata" poster="${thumbUrl}"></video></div>`;
    } else if (hasThumbnail) {
      previewHtml = `<div class="output-preview"><img src="${thumbUrl}" alt="ì¸ë„¤ì¼"></div>`;
    }

    // ë²„íŠ¼ë“¤
    const videoBtn = hasVideo
      ? `<button class="btn btn-sm btn-green" onclick="window.open('${videoUrl}')">ğŸ“¥ ì˜ìƒ</button>`
      : '';
    const thumbBtn = hasThumbnail
      ? `<button class="btn btn-sm btn-outline" onclick="window.open('${thumbUrl}')">ğŸ–¼ï¸ ì¸ë„¤ì¼</button>`
      : '';

    html += `
    <div class="output-card">
      <div class="output-card-header">
        <span class="platform-icon">${cfg.icon}</span>
        <span class="platform-name">${cfg.name}</span>
        <span class="platform-badge ${cfg.badge}">${cfg.badgeText}</span>
      </div>
      <div class="output-card-body">
        ${previewHtml}
        <div class="output-field">
          <span class="output-label">ì œëª©</span>
          <div class="output-value title-val">${escHtml(content.title || '(ìƒì„± ëŒ€ê¸°)')}</div>
        </div>
        <div class="output-field">
          <span class="output-label">${pName==='naver_blog'?'ë³¸ë¬¸':'ìº¡ì…˜/ì„¤ëª…'}</span>
          <div class="output-value">${escHtml(content.body || content.caption || content.description || '(ì—†ìŒ)')}</div>
        </div>
        <div class="output-field">
          <span class="output-label">í•´ì‹œíƒœê·¸ (${hashtags.length})</span>
          <div class="tag-cloud">${tagHtml || '<span style="color:var(--text3);font-size:12px">(ì—†ìŒ)</span>'}</div>
        </div>
        ${content.narration ? `<div class="output-field">
          <span class="output-label">ë‚˜ë ˆì´ì…˜ (${content.narration.length}ì¥ë©´)</span>
          <div class="output-value">${(content.narration||[]).map((s,i)=>`${i+1}. ${escHtml(s)}`).join('\n')}</div>
        </div>` : ''}
      </div>
      <div class="output-card-footer">
        <button class="btn btn-sm btn-outline" onclick="copyContent('${pName}')">ğŸ“‹ ë³µì‚¬</button>
        ${thumbBtn}
        ${videoBtn}
      </div>
    </div>`;
  }

  grid.innerHTML = html || '<div class="output-empty">ê²°ê³¼ ì—†ìŒ</div>';
  // ê²°ê³¼ ë°ì´í„° ì €ì¥ (ë³µì‚¬ìš©)
  window._lastResults = results;
}

function copyContent(platform) {
  if (!window._lastResults) return;
  const pData = window._lastResults.platforms[platform];
  if (!pData || !pData.content) return;
  const c = pData.content;
  let text = '';
  if (c.title) text += 'ì œëª©: ' + c.title + '\n\n';
  if (c.body) text += c.body + '\n\n';
  if (c.caption) text += c.caption + '\n\n';
  if (c.hashtags) text += (c.hashtags || []).join(' ') + '\n';
  navigator.clipboard.writeText(text).then(() => addLog(platform + ' ì½˜í…ì¸  í´ë¦½ë³´ë“œ ë³µì‚¬ ì™„ë£Œ', 'ok'));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ë¯¸ë””ì–´ ê²€ìƒ‰
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchMediaTab(tab, el) {
  currentMediaTab = tab;
  document.querySelectorAll('.media-tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');

  const content = document.getElementById('media-content');
  const input = document.getElementById('media-query');
  const results = document.getElementById('media-results');
  results.innerHTML = '';

  if (tab === 'stock') {
    input.placeholder = 'ê²€ìƒ‰ì–´ ì…ë ¥ (ì˜ˆ: ëˆì¹´ì¸ , í”„ëœì°¨ì´ì¦ˆ)';
  } else if (tab === 'social') {
    input.placeholder = 'TikTok, YouTube, Instagram URL ë¶™ì—¬ë„£ê¸°';
  } else {
    input.placeholder = 'AI ì´ë¯¸ì§€ ìƒì„± í”„ë¡¬í”„íŠ¸ (ì˜ˆ: í”„ë¦¬ë¯¸ì—„ ëˆì¹´ì¸  ì ‘ì‹œ ìœ„ì—)';
  }
}

async function searchMedia() {
  const query = document.getElementById('media-query').value.trim();
  if (!query) return;

  const results = document.getElementById('media-results');
  results.innerHTML = '<div style="color:var(--text3);font-size:12px;padding:10px">ê²€ìƒ‰ ì¤‘...</div>';

  try {
    let endpoint, body;
    if (currentMediaTab === 'stock') {
      endpoint = '/api/media/search';
      body = { query, type: 'image' };
    } else if (currentMediaTab === 'social') {
      endpoint = '/api/media/social';
      body = { url: query };
    } else {
      endpoint = '/api/media/ai-generate';
      body = { prompt: query, type: 'image' };
    }

    const resp = await fetch(API + endpoint, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(body),
    });
    const data = await resp.json();

    if (data.error) {
      results.innerHTML = `<div style="color:var(--red);font-size:12px;padding:10px">ì˜¤ë¥˜: ${escHtml(data.error)}</div>`;
      return;
    }

    if (currentMediaTab === 'stock' && data.results) {
      results.innerHTML = data.results.map(img =>
        `<img class="media-thumb" src="${img.thumb || img.url}" title="${escHtml(img.title || '')}" onclick="addLog('ì´ë¯¸ì§€ ì„ íƒ: ${escHtml(img.title||'')}','ok')" />`
      ).join('');
    } else if (currentMediaTab === 'social') {
      results.innerHTML = `<div style="color:var(--green);font-size:12px;padding:10px">âœ… ë‹¤ìš´ë¡œë“œ ì™„ë£Œ: ${JSON.stringify(data.result || data)}</div>`;
    } else {
      results.innerHTML = `<div style="color:var(--green);font-size:12px;padding:10px">âœ… ${data.response || JSON.stringify(data)}</div>`;
    }
    addLog('ë¯¸ë””ì–´ ê²€ìƒ‰ ì™„ë£Œ: ' + query, 'ok');
  } catch(e) {
    results.innerHTML = `<div style="color:var(--red);font-size:12px;padding:10px">ì˜¤ë¥˜: ${e.message}</div>`;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ë¡œê·¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addLog(msg, type) {
  const panel = document.getElementById('log-panel');
  const time = new Date().toLocaleTimeString('ko-KR', {hour:'2-digit',minute:'2-digit',second:'2-digit'});
  const cls = type === 'ok' ? 'ok' : type === 'err' ? 'err' : type === 'warn' ? 'warn' : '';
  panel.innerHTML += `<div class="log-line ${cls}"><span class="time">[${time}]</span> ${escHtml(msg)}</div>`;
  panel.scrollTop = panel.scrollHeight;
}

function clearLog() {
  document.getElementById('log-panel').innerHTML = '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ìœ í‹¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function escHtml(s) {
  if (!s) return '';
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ìº í˜ì¸ íˆìŠ¤í† ë¦¬
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadHistory() {
  try {
    const resp = await fetch(API + '/api/campaigns?limit=20');
    const data = await resp.json();
    const body = document.getElementById('history-body');
    if (!data.length) {
      body.innerHTML = '<tr><td colspan="8" style="text-align:center;color:var(--text3)">ìº í˜ì¸ ì´ë ¥ ì—†ìŒ</td></tr>';
      return;
    }
    body.innerHTML = data.map(c => {
      const statusCls = c.status==='complete'?'ok':c.status==='error'?'err':'';
      const statusIcon = c.status==='complete'?'âœ…':c.status==='error'?'âŒ':c.status==='running'?'ğŸ”„':'â¸';
      const platforms = c.platforms ? JSON.parse(c.platforms).join(', ') : '';
      const date = c.created_at ? new Date(c.created_at).toLocaleString('ko-KR',{month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'}) : '';
      return `<tr>
        <td style="font-family:monospace;font-size:11px">${c.id.slice(0,8)}</td>
        <td><b>${escHtml(c.topic?.slice(0,30))}</b></td>
        <td>${escHtml(c.brand||'ì—†ìŒ')}</td>
        <td style="font-size:11px">${escHtml(platforms)}</td>
        <td><span class="log-line ${statusCls}" style="margin:0">${statusIcon} ${c.status}</span></td>
        <td style="font-size:11px">$${(c.cost_usd||0).toFixed(4)}</td>
        <td style="font-size:11px">${date}</td>
        <td>${c.status==='complete'?`<button class="btn btn-sm btn-outline" onclick="reuseCampaign('${c.id}')">ì¬ì‚¬ìš©</button>`:''}</td>
      </tr>`;
    }).join('');
  } catch(e) {
    document.getElementById('history-body').innerHTML =
      '<tr><td colspan="8" style="color:var(--red)">íˆìŠ¤í† ë¦¬ ë¡œë”© ì‹¤íŒ¨</td></tr>';
  }
}

async function reuseCampaign(id) {
  try {
    const resp = await fetch(API + '/api/campaigns/' + id);
    const data = await resp.json();
    if (data.topic) {
      document.getElementById('topic-input').value = data.topic;
      if (data.brand) {
        const chip = document.querySelector(`.brand-chip[data-brand="${data.brand}"]`);
        if (chip) selectBrand(chip);
      }
      addLog('ìº í˜ì¸ ì¬ì‚¬ìš©: ' + data.topic, 'ok');
    }
  } catch(e) { addLog('ìº í˜ì¸ ë¡œë”© ì‹¤íŒ¨: ' + e.message, 'err'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ë¹„ìš© ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function updateCostBadge() {
  try {
    const resp = await fetch(API + '/api/cost');
    const data = await resp.json();
    const krw = ((data.total_usd || 0) * 1400).toFixed(0);
    document.getElementById('cost-badge').textContent = `API Cost: â‚©${Number(krw).toLocaleString()}`;
  } catch(e) {}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// V1/V2 ëª¨ë“œ ì „í™˜
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentMode = 'v1';

function switchMode(mode) {
  currentMode = mode;
  document.getElementById('mode-v1-btn').classList.toggle('active', mode === 'v1');
  document.getElementById('mode-v2-btn').classList.toggle('active', mode === 'v2');
  document.getElementById('v1-panel').style.display = mode === 'v1' ? 'block' : 'none';
  document.getElementById('v2-panel').classList.toggle('visible', mode === 'v2');
  if (mode === 'v2') {
    addLog('V2 ëª¨ë“œ í™œì„±í™”: Coupang Profit Maximizer', 'ok');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// V2 ëŒ€í™”í˜• íŒŒì´í”„ë¼ì¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let v2JobId = null;
let v2EventSource = null;

async function v2SubmitLink() {
  const productUrl = document.getElementById('v2-product-url').value.trim();
  const affiliateUrl = document.getElementById('v2-affiliate-url').value.trim();
  const iframeTag = document.getElementById('v2-iframe-tag').value.trim();
  const productName = document.getElementById('v2-product-name').value.trim();

  if (!productUrl) { alert('ğŸ“¦ ìƒí’ˆì •ë³´ ë§í¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”'); return; }
  if (!affiliateUrl) { alert('ğŸ’° ë‹¨ì¶• URLì„ ì…ë ¥í•˜ì„¸ìš”'); return; }

  document.getElementById('v2-btn-submit').disabled = true;
  v2UpdateState('analyzing', 'ìƒí’ˆ ë¶„ì„ ì¤‘...');
  addLog(`[V2] ìƒí’ˆì •ë³´: ${productUrl.slice(0, 50)}...`, 'ok');
  addLog(`[V2] ë‹¨ì¶•URL: ${affiliateUrl}`, 'ok');
  if (iframeTag) addLog(`[V2] iframe: ${iframeTag.slice(0, 50)}...`, 'ok');
  if (productName) addLog(`[V2] ìƒí’ˆëª…: ${productName}`, 'ok');

  // V2 10ë‹¨ê³„ ë¦¬ì…‹
  for (let i = 1; i <= 10; i++) v2UpdateStep(i, 'pending', '');

  try {
    // Step 1: ìº í˜ì¸ ì‹œì‘
    const startResp = await fetch(API + '/api/v2/campaign/start', {
      method: 'POST', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({}),
    });
    const startData = await startResp.json();
    v2JobId = startData.job_id;
    addLog('[V2] Job ID: ' + v2JobId);

    // Step 2: ë§í¬ ì œì¶œ (ìƒí’ˆì •ë³´ + ìˆ˜ìµë§í¬ + ìƒí’ˆëª…)
    const linkResp = await fetch(API + `/api/v2/campaign/${v2JobId}/link`, {
      method: 'POST', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        coupang_link: productUrl,
        affiliate_link: affiliateUrl,
        iframe_tag: iframeTag,
        product_name: productName,
      }),
    });
    const linkData = await linkResp.json();

    // SSE ì—°ê²°
    if (v2EventSource) v2EventSource.close();
    v2EventSource = new EventSource(API + `/api/v2/campaign/${v2JobId}/stream`);
    v2EventSource.onmessage = (e) => v2HandleSSE(JSON.parse(e.data));
    v2EventSource.onerror = () => {
      addLog('[V2] SSE ì—°ê²° ì¢…ë£Œ', 'warn');
      v2EventSource.close();
      document.getElementById('v2-btn-submit').disabled = false;
    };

  } catch(e) {
    addLog('[V2] ì˜¤ë¥˜: ' + e.message, 'err');
    document.getElementById('v2-btn-submit').disabled = false;
    v2UpdateState('awaiting', 'ë§í¬ ì…ë ¥ ëŒ€ê¸°');
  }
}

function v2HandleSSE(msg) {
  // ë‹¨ê³„ë³„ ì§„í–‰
  if (msg.type === 'v2_step') {
    v2UpdateStep(msg.step, msg.status, msg.detail || '');
    const progress = Math.min((msg.step / 10) * 100, 100);
    document.getElementById('v2-pipeline-progress').style.width = progress + '%';
    addLog(`[V2 Step ${msg.step}] ${msg.name}: ${msg.detail || msg.status}`,
           msg.status === 'error' ? 'err' : 'ok');
  }

  // ìƒíƒœ ë³€ê²½
  if (msg.type === 'state_change') {
    const stateMap = {
      'awaiting_link': ['awaiting', 'ë§í¬ ì…ë ¥ ëŒ€ê¸°'],
      'analyzing': ['analyzing', 'ë¶„ì„ ì¤‘...'],
      'awaiting_confirm': ['confirm', 'ì´ˆì•ˆ í™•ì¸ ëŒ€ê¸°'],
      'executing': ['executing', 'ì‹¤í–‰ ì¤‘...'],
      'complete': ['complete', 'ì™„ë£Œ!'],
    };
    const [cls, label] = stateMap[msg.state] || ['awaiting', msg.state];
    v2UpdateState(cls, label);

    if (msg.message) addLog('[V2] ' + msg.message, 'ok');

    // ì´ˆì•ˆ í™•ì¸ ëŒ€ê¸° â†’ ë¯¸ë¦¬ë³´ê¸° + ì‹¤í–‰ ë²„íŠ¼ í‘œì‹œ
    if (msg.state === 'awaiting_confirm') {
      document.getElementById('v2-confirm-area').style.display = 'block';
      document.getElementById('v2-preview-grid').style.display = 'grid';

      // ìƒí’ˆ ì •ë³´ í‘œì‹œ
      if (msg.draft && msg.draft.product) {
        const p = msg.draft.product;
        document.getElementById('v2-product-area').style.display = 'block';
        document.getElementById('v2-product-area').innerHTML = `
          <div class="v2-product-card">
            <h3>ğŸ“¦ ${escHtml(p.title)}</h3>
            <p>${escHtml(p.price || '')} | ${escHtml(p.description?.slice(0, 100) || '')}</p>
          </div>`;
      }

      // ë¸”ë¡œê·¸ ë¯¸ë¦¬ë³´ê¸°
      if (msg.draft && msg.draft.blog) {
        const blog = msg.draft.blog;
        let blogPreview = `ğŸ“Œ ì œëª©: ${escHtml(blog.title || '')}\n\n`;
        blogPreview += `ğŸ“ ì¸íŠ¸ë¡œ: ${escHtml(blog.intro || '')}\n\n`;
        (blog.body_sections || []).forEach((s, i) => {
          blogPreview += `[ë³¸ë¬¸${i+1}] ${escHtml(s)}\n\n`;
        });
        if (blog.hashtags) blogPreview += `ğŸ·ï¸ ${blog.hashtags.join(' ')}`;
        document.getElementById('v2-blog-preview').textContent = blogPreview;
      }

      // ìˆí¼ ëŒ€ë³¸ ë¯¸ë¦¬ë³´ê¸°
      if (msg.draft && msg.draft.shorts) {
        const shorts = msg.draft.shorts;
        if (shorts.error) {
          document.getElementById('v2-shorts-preview').textContent = 'âš ï¸ ìˆí¼ ëŒ€ë³¸ ìƒì„± ì‹¤íŒ¨: ' + shorts.error;
        } else {
          let shortsPreview = '';
          (shorts.scenes || []).forEach(s => {
            shortsPreview += `ğŸ¬ ì¥ë©´${s.scene_num}: [${s.emotion || 'friendly'}] ${s.duration || 5}ì´ˆ\n`;
            shortsPreview += `   "${escHtml(s.text)}"\n\n`;
          });
          document.getElementById('v2-shorts-preview').textContent = shortsPreview || '(ëŒ€ë³¸ ì—†ìŒ)';
        }
      }
    }
  }

  // ì™„ë£Œ
  if (msg.type === 'v2_complete' || msg.type === 'v2_done') {
    v2UpdateState('complete', 'ì™„ë£Œ!');
    document.getElementById('v2-pipeline-progress').style.width = '100%';
    addLog('ğŸ‰ V2 íŒŒì´í”„ë¼ì¸ 10ë‹¨ê³„ ì™„ë£Œ!', 'ok');
    document.getElementById('v2-btn-submit').disabled = false;

    // Drive URL
    if (msg.results && msg.results.drive_url) {
      addLog('ğŸ“ Drive URL: ' + msg.results.drive_url, 'ok');
    }

    if (v2EventSource) v2EventSource.close();
  }

  // ì—ëŸ¬
  if (msg.type === 'error') {
    addLog('[V2] ì˜¤ë¥˜: ' + msg.error, 'err');
    v2UpdateState('awaiting', 'ì˜¤ë¥˜ ë°œìƒ');
    document.getElementById('v2-btn-submit').disabled = false;
    if (v2EventSource) v2EventSource.close();
  }
}

async function v2Confirm() {
  if (!v2JobId) return;
  document.getElementById('v2-btn-confirm').disabled = true;
  v2UpdateState('executing', 'ì‹¤í–‰ ì¤‘...');
  addLog('[V2] ì‹¤í–‰ í™•ì¸ â€” 10ë‹¨ê³„ íŒŒì´í”„ë¼ì¸ ì‹œì‘', 'ok');

  try {
    await fetch(API + `/api/v2/campaign/${v2JobId}/confirm`, {
      method: 'POST', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({}),
    });
  } catch(e) {
    addLog('[V2] ì‹¤í–‰ í™•ì¸ ì˜¤ë¥˜: ' + e.message, 'err');
    document.getElementById('v2-btn-confirm').disabled = false;
  }
}

function v2UpdateState(cls, label) {
  const badge = document.getElementById('v2-state-badge');
  badge.className = 'v2-state-badge ' + cls;
  badge.textContent = label;
}

function v2UpdateStep(step, status, detail) {
  const el = document.getElementById('v2-step-' + step);
  if (!el) return;
  const icons = {pending:'â¸',running:'ğŸ”„',complete:'âœ…',error:'âŒ'};
  const labels = {pending:'ëŒ€ê¸°',running:'ì‹¤í–‰ ì¤‘',complete:'ì™„ë£Œ',error:'ì˜¤ë¥˜'};
  el.className = 'step-status ' + status;
  el.textContent = (icons[status]||'') + ' ' + (labels[status]||status);
  // í™œì„± í–‰
  document.querySelectorAll('#v2-auto-table tr[data-v2step]').forEach(tr => tr.classList.remove('active'));
  if (status === 'running') {
    const row = document.querySelector(`#v2-auto-table tr[data-v2step="${step}"]`);
    if (row) row.classList.add('active');
  }
}
</script>
</body>
</html>
