<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>YJ MCN â€” Coupang Profit Max V3.1</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0a0c13;--card:#131621;--card2:#1c2033;--border:#272b42;
  --primary:#6366f1;--primary-light:#818cf8;
  --accent:#f59e0b;--green:#22c55e;--red:#ef4444;--blue:#3b82f6;--purple:#a855f7;--orange:#f97316;--cyan:#06b6d4;
  --text:#e2e8f0;--text2:#94a3b8;--text3:#64748b;
  --naver:#03c75a;--youtube:#ff0000;--insta:#e4405f;
  /* ì¹´í…Œê³ ë¦¬ ì»¬ëŸ¬ */
  --cat-prep:#3b82f6;--cat-collect:#22c55e;--cat-ai:#a855f7;--cat-optimize:#f97316;--cat-deploy:#ef4444
}
body{font-family:'Pretendard Variable','Noto Sans KR',system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;line-height:1.6}
a{color:var(--primary-light);text-decoration:none}
button{font-family:inherit;cursor:pointer}
input,textarea,select{font-family:inherit}

/* â”€â”€ Header â”€â”€ */
.header{background:linear-gradient(135deg,#1a0730 0%,#1e1b4b 40%,#172554 100%);border-bottom:1px solid var(--border);padding:14px 0}
.header-inner{max-width:1440px;margin:0 auto;padding:0 24px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px}
.logo{display:flex;align-items:center;gap:12px}
.logo-icon{width:46px;height:46px;background:linear-gradient(135deg,var(--primary),var(--purple));border-radius:12px;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:15px;color:#fff;letter-spacing:-.5px}
.logo h1{font-size:19px;font-weight:800;color:#fff;letter-spacing:-.3px}
.logo p{font-size:10px;color:var(--primary-light);margin-top:1px;letter-spacing:.5px;text-transform:uppercase}
.header-right{display:flex;align-items:center;gap:8px}
.badge{display:inline-flex;align-items:center;gap:4px;padding:4px 12px;border-radius:20px;font-size:11px;font-weight:700}
.badge-online{background:var(--green);color:#000}
.badge-cost{background:var(--card2);color:var(--accent);border:1px solid var(--border)}
.badge-v3{background:linear-gradient(135deg,var(--purple),var(--primary));color:#fff;font-size:10px;padding:3px 10px}

/* â”€â”€ Main â”€â”€ */
.main{max-width:1440px;margin:0 auto;padding:20px 24px}

/* â”€â”€ Section â”€â”€ */
.section{margin-bottom:20px}
.section-title{font-size:14px;font-weight:700;margin-bottom:10px;display:flex;align-items:center;gap:8px;color:var(--text)}
.section-title .icon{font-size:16px}

/* â”€â”€ ì…ë ¥ íŒ¨ë„ â”€â”€ */
.input-panel{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px;margin-bottom:20px}
.input-panel-header{font-size:16px;font-weight:800;margin-bottom:14px;display:flex;align-items:center;gap:8px}
.field-row{display:flex;align-items:center;gap:10px;margin-bottom:10px}
.field-label{min-width:110px;font-size:12px;font-weight:700;flex-shrink:0}
.field-input{flex:1;background:var(--card2);border:1px solid var(--border);border-radius:8px;padding:10px 14px;color:var(--text);font-size:13px;outline:none;transition:border-color .2s}
.field-input:focus{border-color:var(--primary)}
.field-input::placeholder{color:var(--text3)}
textarea.field-input{resize:vertical;min-height:60px;line-height:1.5}

/* â”€â”€ ì„¤ì • í–‰ â”€â”€ */
.settings-row{display:flex;gap:16px;flex-wrap:wrap;align-items:center;margin-top:14px;padding-top:14px;border-top:1px solid var(--border)}

/* â”€â”€ ë²„íŠ¼ â”€â”€ */
.btn{padding:10px 20px;border-radius:8px;font-size:13px;font-weight:700;border:none;transition:all .2s}
.btn:hover{opacity:.85;transform:translateY(-1px)}
.btn:active{transform:translateY(0)}
.btn-primary{background:var(--primary);color:#fff}
.btn-green{background:var(--green);color:#000}
.btn-orange{background:var(--orange);color:#000}
.btn-outline{background:transparent;border:1px solid var(--border);color:var(--text2)}
.btn-sm{padding:6px 14px;font-size:12px}
.btn:disabled{opacity:.4;cursor:not-allowed;transform:none}
.btn-launch{background:linear-gradient(135deg,var(--purple),var(--primary));color:#fff;padding:14px 32px;font-size:15px;border-radius:10px;width:100%;margin-top:14px;letter-spacing:.3px;box-shadow:0 4px 20px rgba(99,102,241,.3)}
.btn-launch:hover{box-shadow:0 6px 28px rgba(99,102,241,.5)}

/* â”€â”€ í† ê¸€ ìŠ¤ìœ„ì¹˜ â”€â”€ */
.toggle-switch{position:relative;display:inline-flex;align-items:center;gap:6px;cursor:pointer;font-size:12px}
.toggle-switch input{display:none}
.toggle-slider{width:36px;height:20px;border-radius:10px;background:var(--border);position:relative;transition:all .3s}
.toggle-slider::after{content:'';position:absolute;left:2px;top:2px;width:16px;height:16px;border-radius:50%;background:var(--text3);transition:all .3s}
.toggle-switch input:checked+.toggle-slider{background:var(--green)}
.toggle-switch input:checked+.toggle-slider::after{left:18px;background:#fff}
.toggle-label{color:var(--text2);font-weight:500;font-size:11px}
.toggle-switch input:checked~.toggle-label{color:var(--green)}

/* â”€â”€ ì´ˆì•ˆ ë¯¸ë¦¬ë³´ê¸° â”€â”€ */
.draft-panel{background:var(--card);border:2px solid var(--cat-prep);border-radius:14px;overflow:hidden;margin-bottom:20px;display:none}
.draft-panel.visible{display:block}
.draft-header{padding:14px 18px;background:rgba(59,130,246,.08);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.draft-header h3{font-size:15px;font-weight:800;display:flex;align-items:center;gap:8px}
.draft-tabs{display:flex;border-bottom:1px solid var(--border)}
.draft-tab{flex:1;padding:10px;text-align:center;font-size:12px;font-weight:600;color:var(--text3);cursor:pointer;border:none;background:none;transition:all .2s}
.draft-tab:hover{color:var(--text)}
.draft-tab.active{color:var(--cat-prep);border-bottom:2px solid var(--cat-prep)}
.draft-body{padding:16px;max-height:300px;overflow-y:auto;font-size:13px;color:var(--text2);white-space:pre-wrap;word-break:break-word}
.draft-body iframe{width:100%;height:260px;border:none;border-radius:6px}

/* â”€â”€ íŒŒì´í”„ë¼ì¸ í…Œì´ë¸” â”€â”€ */
.pipe-table-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch}
.pipe-table{width:100%;border-collapse:separate;border-spacing:0;background:var(--card);border:1px solid var(--border);border-radius:12px;overflow:hidden;min-width:600px}
.pipe-table th{background:var(--card2);text-align:left;font-size:10px;color:var(--text3);font-weight:600;text-transform:uppercase;padding:8px 12px;border-bottom:1px solid var(--border);letter-spacing:.6px}
.pipe-table td{padding:8px 12px;border-bottom:1px solid var(--border);font-size:13px;vertical-align:middle}
.pipe-table tr:last-child td{border-bottom:none}
.pipe-table tr.active{background:rgba(99,102,241,.06)}
.step-num{width:28px;height:28px;border-radius:8px;display:inline-flex;align-items:center;justify-content:center;font-size:12px;font-weight:800;color:#fff}
.cat-badge{display:inline-block;padding:2px 8px;border-radius:4px;font-size:10px;font-weight:700;letter-spacing:.3px}
.cat-prep{background:rgba(59,130,246,.15);color:var(--cat-prep)}.cat-prep .step-num{background:var(--cat-prep)}
.cat-collect{background:rgba(34,197,94,.15);color:var(--cat-collect)}.cat-collect .step-num{background:var(--cat-collect)}
.cat-ai{background:rgba(168,85,247,.15);color:var(--cat-ai)}.cat-ai .step-num{background:var(--cat-ai)}
.cat-optimize{background:rgba(249,115,22,.15);color:var(--cat-optimize)}.cat-optimize .step-num{background:var(--cat-optimize)}
.cat-deploy{background:rgba(239,68,68,.15);color:var(--cat-deploy)}.cat-deploy .step-num{background:var(--cat-deploy)}
.step-status{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:12px;font-size:11px;font-weight:600}
.step-status.pending{background:var(--card2);color:var(--text3)}
.step-status.running{background:rgba(245,158,11,.15);color:var(--accent);animation:pulse 1.5s infinite}
.step-status.complete{background:rgba(34,197,94,.15);color:var(--green)}
.step-status.error{background:rgba(239,68,68,.15);color:var(--red)}
.step-status.skipped{background:var(--card2);color:var(--text3)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
.progress-bar{width:100%;height:6px;background:var(--card2);border-radius:3px;overflow:hidden;margin:10px 0}
.progress-fill{height:100%;background:linear-gradient(90deg,var(--cat-prep),var(--cat-collect),var(--cat-ai),var(--cat-optimize),var(--cat-deploy));border-radius:3px;transition:width .6s ease;width:0%}

/* â”€â”€ ë¯¸ë””ì–´ ë·°ì–´ â”€â”€ */
.media-panel{background:var(--card);border:1px solid var(--border);border-radius:14px;overflow:hidden}
.media-tabs{display:flex;border-bottom:1px solid var(--border)}
.media-tab{flex:1;padding:10px;text-align:center;font-size:12px;font-weight:600;color:var(--text3);cursor:pointer;border:none;background:none;transition:all .2s}
.media-tab:hover{color:var(--text)}
.media-tab.active{color:var(--primary-light);border-bottom:2px solid var(--primary)}
.media-body{padding:16px;min-height:120px}
.media-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:8px}
.media-thumb{width:100%;aspect-ratio:1;object-fit:cover;border-radius:6px;cursor:pointer;border:2px solid transparent;transition:border-color .2s}
.media-thumb:hover{border-color:var(--primary)}
.media-empty{text-align:center;color:var(--text3);font-size:12px;padding:30px}

/* â”€â”€ 3í”Œë«í¼ ê²°ê³¼ â”€â”€ */
.result-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px}
@media(max-width:1000px){.result-grid{grid-template-columns:1fr 1fr}}
@media(max-width:640px){.result-grid{grid-template-columns:1fr}}
.result-card{background:var(--card);border:1px solid var(--border);border-radius:14px;overflow:hidden}
.result-card-header{padding:12px 14px;display:flex;align-items:center;gap:8px;border-bottom:1px solid var(--border)}
.result-card-header .plat-icon{font-size:18px}
.result-card-header .plat-name{font-size:13px;font-weight:700}
.result-card-header .plat-badge{margin-left:auto;font-size:10px;padding:2px 8px;border-radius:4px;font-weight:600}
.badge-naver{background:rgba(3,199,90,.15);color:var(--naver)}
.badge-youtube{background:rgba(255,0,0,.12);color:var(--youtube)}
.badge-insta{background:rgba(228,64,95,.12);color:var(--insta)}
.result-card-body{padding:14px;display:flex;flex-direction:column;gap:8px}
.result-field{display:flex;flex-direction:column;gap:3px}
.result-label{font-size:10px;color:var(--text3);font-weight:600;text-transform:uppercase;letter-spacing:.5px}
.result-value{font-size:12px;color:var(--text);background:var(--card2);border-radius:6px;padding:8px 10px;max-height:100px;overflow-y:auto;white-space:pre-wrap;word-break:break-word}
.result-preview{width:100%;border-radius:6px;overflow:hidden;background:#000;margin-bottom:4px}
.result-preview video{width:100%;max-height:240px;display:block}
.result-preview img{width:100%;max-height:180px;object-fit:contain;display:block}
.result-card-footer{padding:10px 14px;border-top:1px solid var(--border);display:flex;gap:6px;flex-wrap:wrap}
.result-empty{text-align:center;color:var(--text3);font-size:12px;padding:30px;grid-column:1/-1}
.tag-cloud{display:flex;flex-wrap:wrap;gap:4px}
.tag{padding:2px 7px;border-radius:4px;font-size:10px;background:var(--card2);color:var(--text2);border:1px solid var(--border)}

/* â”€â”€ ë¡œê·¸ íŒ¨ë„ â”€â”€ */
.log-panel{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:10px 12px;max-height:180px;overflow-y:auto;font-family:'Cascadia Code','Fira Code',monospace;font-size:11px;color:var(--text2);word-break:break-all}
.log-line{margin-bottom:2px;opacity:.85}
.log-line .time{color:var(--text3)}
.log-line.ok{color:var(--green)}.log-line.err{color:var(--red)}.log-line.warn{color:var(--accent)}

/* â”€â”€ íˆìŠ¤í† ë¦¬ â”€â”€ */
.hist-table{width:100%;border-collapse:separate;border-spacing:0;background:var(--card);border:1px solid var(--border);border-radius:10px;overflow:hidden}
.hist-table th{background:var(--card2);text-align:left;font-size:10px;color:var(--text3);font-weight:600;text-transform:uppercase;padding:8px 10px;border-bottom:1px solid var(--border)}
.hist-table td{padding:8px 10px;border-bottom:1px solid var(--border);font-size:12px}
.hist-table tr:last-child td{border-bottom:none}

/* â”€â”€ ì‹œìŠ¤í…œ ìƒíƒœ â”€â”€ */
.status-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:8px}
.status-item{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:8px 10px;display:flex;align-items:center;gap:8px}
.status-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.status-dot.on{background:var(--green);box-shadow:0 0 6px rgba(34,197,94,.4)}
.status-dot.off{background:var(--text3)}
.status-name{font-size:11px;font-weight:600}
.status-detail{font-size:10px;color:var(--text3)}

/* â”€â”€ Footer â”€â”€ */
.footer{text-align:center;padding:20px;color:var(--text3);font-size:10px;border-top:1px solid var(--border);margin-top:24px}

/* â”€â”€ Collapsible â”€â”€ */
.collapse-btn{background:none;border:none;color:var(--text3);font-size:12px;cursor:pointer;margin-left:auto;padding:2px 8px}
.collapse-btn:hover{color:var(--text)}
.collapsible{overflow:hidden;transition:max-height .3s ease}
.collapsible.collapsed{max-height:0 !important}

/* â”€â”€ ì ‘ê·¼ì„±: í¬ì»¤ìŠ¤ ê°€ì‹œì„± â”€â”€ */
button:focus-visible,input:focus-visible,select:focus-visible,textarea:focus-visible{outline:2px solid var(--primary-light);outline-offset:2px}
.toggle-switch input:focus-visible+.toggle-slider{outline:2px solid var(--primary-light);outline-offset:2px}

/* â”€â”€ ë°ì´í„° ê´€ë¦¬ ë°” â”€â”€ */
.data-mgmt-bar{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:10px 16px;display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:20px}
.data-mgmt-bar .mgmt-label{font-size:11px;font-weight:700;color:var(--text3);margin-right:4px}
.btn-mgmt{padding:6px 14px;border-radius:6px;font-size:12px;font-weight:600;border:none;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;gap:4px}
.btn-mgmt:hover{opacity:.85;transform:translateY(-1px)}
.btn-mgmt:active{transform:translateY(0)}
.btn-backup{background:var(--card2);color:var(--text2);border:1px solid var(--border)}
.btn-restore{background:var(--card2);color:var(--text2);border:1px solid var(--border)}
.btn-reset{background:rgba(239,68,68,.15);color:var(--red);border:1px solid rgba(239,68,68,.25)}
.btn-reset:hover{background:rgba(239,68,68,.25)}

/* â”€â”€ ë°˜ì‘í˜• â”€â”€ */
@media(max-width:768px){
  .result-grid{grid-template-columns:1fr}
  .settings-row{flex-direction:column;align-items:flex-start}
  .field-row{flex-direction:column;align-items:flex-start}
  .field-label{min-width:unset}
  .data-mgmt-bar{justify-content:center}
}
</style>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;700;800&display=swap" rel="stylesheet">
</head>
<body>

<!-- â•â•â• HEADER â•â•â• -->
<header class="header">
  <div class="header-inner">
    <div class="logo">
      <div class="logo-icon">YJ</div>
      <div>
        <h1>YJ MCN Coupang Profit Max</h1>
        <p>V3.1 Ultimate &mdash; 8-Step Pipeline</p>
      </div>
    </div>
    <div class="header-right">
      <span class="badge badge-v3">V3.1</span>
      <span class="badge badge-cost" id="cost-badge">API â‚©0</span>
      <span class="badge badge-online" id="status-badge">CONNECTING...</span>
    </div>
  </div>
</header>

<main class="main">

  <!-- â•â•â• ì¿ íŒ¡ íŒŒíŠ¸ë„ˆìŠ¤ ì„¤ì • â•â•â• -->
  <div class="input-panel">
    <div class="input-panel-header">ğŸ›’ ì¿ íŒ¡ íŒŒíŠ¸ë„ˆìŠ¤ V3.1 &mdash; ìˆ˜ìµ ê·¹ëŒ€í™” íŒŒì´í”„ë¼ì¸</div>

    <div class="field-row">
      <span class="field-label" style="color:var(--accent)">ğŸ“¦ ì¿ íŒ¡ ìƒí’ˆ URL</span>
      <input class="field-input" type="text" id="inp-coupang-url" placeholder="https://www.coupang.com/vp/products/... (í•„ìˆ˜)" />
    </div>
    <div class="field-row">
      <span class="field-label" style="color:var(--green)">ğŸ’° ì œíœ´ ë§í¬</span>
      <input class="field-input" type="text" id="inp-affiliate" placeholder="https://link.coupang.com/a/... (ë‹¨ì¶• URL â€” ìë™ìƒì„± ë˜ëŠ” ìˆ˜ë™ì…ë ¥)" />
    </div>
    <div class="field-row">
      <span class="field-label" style="color:var(--blue)">ğŸ·ï¸ ë°°ë„ˆ íƒœê·¸</span>
      <input class="field-input" type="text" id="inp-banner" placeholder='<a href="..."><img src="..."> (ì¿ íŒ¡ ë°°ë„ˆ â€” ì„ íƒ)' />
    </div>
    <div class="field-row">
      <span class="field-label" style="color:var(--text3)">ğŸ“ ìƒí’ˆëª…</span>
      <input class="field-input" type="text" id="inp-product-name" placeholder="(ì„ íƒ) ìŠ¤í¬ë˜í•‘ ì‹¤íŒ¨ ì‹œ ìˆ˜ë™ ì…ë ¥" />
    </div>

    <!-- ì†Œì…œ ë¯¸ë””ì–´ URL -->
    <div class="field-row" style="align-items:flex-start;margin-top:6px">
      <span class="field-label" style="color:var(--purple)">ğŸ¬ ì†Œì…œ URL</span>
      <textarea class="field-input" id="inp-social-urls" rows="2" placeholder="TikTok / Instagram / YouTube / Facebook URL (ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„, ì„ íƒ)"></textarea>
    </div>

    <!-- ì„¤ì • í–‰ -->
    <div class="settings-row">
      <div style="display:flex;align-items:center;gap:8px">
        <label style="font-size:12px;color:var(--text2);font-weight:600">AI:</label>
        <select id="sel-ai" class="field-input" style="flex:unset;width:160px;padding:6px 10px;font-size:12px">
          <option value="">ìë™ (ë¬´ë£Œ ìš°ì„ )</option>
          <option value="gemini">Gemini Flash (ë¬´ë£Œ)</option>
          <option value="gemini_pro">Gemini Pro (ë¬´ë£Œ)</option>
          <option value="ollama">Ollama ë¡œì»¬ (ë¬´ë£Œ)</option>
          <option value="claude_haiku">Claude Haiku (ì €ê°€)</option>
        </select>
      </div>
      <label class="toggle-switch" title="Step 2 í›„ ì´ˆì•ˆ í™•ì¸ í›„ ì§„í–‰">
        <input type="checkbox" id="chk-review" checked aria-label="ê²€í†  ëª¨ë“œ í† ê¸€">
        <span class="toggle-slider"></span>
        <span class="toggle-label">ğŸ“‹ ê²€í†  ëª¨ë“œ</span>
      </label>
      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-left:auto">
        <span style="font-size:11px;font-weight:600;color:var(--text3)">ì—…ë¡œë“œ:</span>
        <label class="toggle-switch"><input type="checkbox" id="up-yt" aria-label="YouTube ì—…ë¡œë“œ í† ê¸€"><span class="toggle-slider"></span><span class="toggle-label">ğŸ“º YT</span></label>
        <label class="toggle-switch"><input type="checkbox" id="up-ig" aria-label="Instagram ì—…ë¡œë“œ í† ê¸€"><span class="toggle-slider"></span><span class="toggle-label">ğŸ“¸ IG</span></label>
        <label class="toggle-switch"><input type="checkbox" id="up-nv" aria-label="ë„¤ì´ë²„ ë¸”ë¡œê·¸ ì—…ë¡œë“œ í† ê¸€"><span class="toggle-slider"></span><span class="toggle-label">ğŸ“ NV</span></label>
        <label class="toggle-switch"><input type="checkbox" id="up-drive" checked aria-label="Google Drive ì•„ì¹´ì´ë¹™ í† ê¸€"><span class="toggle-slider"></span><span class="toggle-label">â˜ï¸ Drive</span></label>
      </div>
    </div>

    <div style="font-size:10px;color:var(--text3);margin-top:10px;padding-left:2px">
      âš ï¸ "ì´ í¬ìŠ¤íŒ…ì€ ì¿ íŒ¡ íŒŒíŠ¸ë„ˆìŠ¤ í™œë™ì˜ ì¼í™˜ìœ¼ë¡œ, ì´ì— ë”°ë¥¸ ì¼ì •ì•¡ì˜ ìˆ˜ìˆ˜ë£Œë¥¼ ì œê³µë°›ìŠµë‹ˆë‹¤." â€” ìë™ ì‚½ì…ë¨
    </div>

    <button class="btn-launch" id="btn-v3-start" onclick="v3Start()">ğŸš€ V3 íŒŒì´í”„ë¼ì¸ ì‹¤í–‰</button>
  </div>

  <!-- â•â•â• ì´ˆì•ˆ ë¯¸ë¦¬ë³´ê¸° (ê²€í† ëª¨ë“œ Step 2 í›„) â•â•â• -->
  <div class="draft-panel" id="draft-panel">
    <div class="draft-header">
      <h3>ğŸ“ ì´ˆì•ˆ ë¯¸ë¦¬ë³´ê¸° &mdash; í™•ì¸ í›„ ì§„í–‰</h3>
      <button class="btn btn-green" id="btn-v3-confirm" onclick="v3Confirm()">âœ… í™•ì¸ &amp; ê³„ì† ì‹¤í–‰</button>
    </div>
    <div class="draft-tabs">
      <button class="draft-tab active" onclick="switchDraftTab('blog',this)">ğŸ“— ë¸”ë¡œê·¸ ì´ˆì•ˆ</button>
      <button class="draft-tab" onclick="switchDraftTab('shorts',this)">ğŸ¬ ìˆí¼ ëŒ€ë³¸</button>
      <button class="draft-tab" onclick="switchDraftTab('product',this)">ğŸ“¦ ìƒí’ˆ ì •ë³´</button>
    </div>
    <div class="draft-body" id="draft-body">ì´ˆì•ˆì´ ìƒì„±ë˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
  </div>

  <!-- â•â•â• 8ë‹¨ê³„ íŒŒì´í”„ë¼ì¸ (ì¹´í…Œê³ ë¦¬ë³„ ì»¬ëŸ¬) â•â•â• -->
  <div class="section">
    <div class="section-title"><span class="icon">ğŸ“‹</span> V3.1 íŒŒì´í”„ë¼ì¸ â€” 8ë‹¨ê³„</div>
    <div class="pipe-table-wrap">
    <table class="pipe-table" id="pipe-table">
      <thead>
        <tr>
          <th style="width:40px">Step</th>
          <th style="width:70px">ì¹´í…Œê³ ë¦¬</th>
          <th>í”„ë¡œì„¸ìŠ¤</th>
          <th>ëª¨ë“ˆ</th>
          <th style="width:90px">Status</th>
        </tr>
      </thead>
      <tbody>
        <tr data-step="1">
          <td><span class="step-num" style="background:var(--cat-prep)">1</span></td>
          <td><span class="cat-badge cat-prep">ì¤€ë¹„</span></td>
          <td><b>ì…ë ¥ ë¶„ì„</b><br><small style="color:var(--text3)">ì¿ íŒ¡ ìŠ¤í¬ë˜í•‘ + ì œíœ´ë§í¬ ìƒì„±</small></td>
          <td style="font-size:11px;color:var(--text3)">coupang_scraper</td>
          <td><span class="step-status pending" id="v3s-1">â¸ ëŒ€ê¸°</span></td>
        </tr>
        <tr data-step="2">
          <td><span class="step-num" style="background:var(--cat-prep)">2</span></td>
          <td><span class="cat-badge cat-prep">ì¤€ë¹„</span></td>
          <td><b>AI ì½˜í…ì¸  ìƒì„±</b><br><small style="color:var(--text3)">ë¸”ë¡œê·¸ V2 + ìˆí¼ ëŒ€ë³¸ (ê²€í† ëª¨ë“œ â†’ ì¼ì‹œì •ì§€)</small></td>
          <td style="font-size:11px;color:var(--text3)">ai_generator</td>
          <td><span class="step-status pending" id="v3s-2">â¸ ëŒ€ê¸°</span></td>
        </tr>
        <tr data-step="3">
          <td><span class="step-num" style="background:var(--cat-collect)">3</span></td>
          <td><span class="cat-badge cat-collect">ìˆ˜ì§‘</span></td>
          <td><b>ë¯¸ë””ì–´ ìˆ˜ì§‘</b><br><small style="color:var(--text3)">TikTokÂ·IGÂ·YTÂ·FB + PexelsÂ·PixabayÂ·Unsplash + GoogleÂ·Pinterest</small></td>
          <td style="font-size:11px;color:var(--text3)">OmniCollector + yt-dlp</td>
          <td><span class="step-status pending" id="v3s-3">â¸ ëŒ€ê¸°</span></td>
        </tr>
        <tr data-step="4">
          <td><span class="step-num" style="background:var(--cat-ai)">4</span></td>
          <td><span class="cat-badge cat-ai">AI ìƒì„±</span></td>
          <td><b>AI ë¯¸ë””ì–´ ìƒì„±</b><br><small style="color:var(--text3)">NanoBanana 4K + Imagen 4.0 + VEO 3.1 (ë§ˆì´í¬ë¡œ í”„ë¡¬í”„íŠ¸)</small></td>
          <td style="font-size:11px;color:var(--text3)">NanoBanana + Imagen + VEO</td>
          <td><span class="step-status pending" id="v3s-4">â¸ ëŒ€ê¸°</span></td>
        </tr>
        <tr data-step="5">
          <td><span class="step-num" style="background:var(--cat-optimize)">5</span></td>
          <td><span class="cat-badge cat-optimize">ìµœì í™”</span></td>
          <td><b>ë„¤ì´ë²„ ë¸”ë¡œê·¸</b><br><small style="color:var(--text3)">ì´ë¯¸ì§€ 5-7ì¥ 860px + HTML êµì°¨ë°°ì¹˜ + CTA + ë©´ì±…ê³ ì§€</small></td>
          <td style="font-size:11px;color:var(--text3)">blog_html_generator</td>
          <td><span class="step-status pending" id="v3s-5">â¸ ëŒ€ê¸°</span></td>
        </tr>
        <tr data-step="6">
          <td><span class="step-num" style="background:var(--cat-optimize)">6</span></td>
          <td><span class="cat-badge cat-optimize">ìµœì í™”</span></td>
          <td><b>ìœ íŠœë¸Œ ì‡¼ì¸ </b><br><small style="color:var(--text3)">1080x1920 60fps 12Mbps + ì˜ìƒì„¸íƒ + ProShorts + 45ì´ˆ</small></td>
          <td style="font-size:11px;color:var(--text3)">ProShortsRenderer + FFmpeg</td>
          <td><span class="step-status pending" id="v3s-6">â¸ ëŒ€ê¸°</span></td>
        </tr>
        <tr data-step="7">
          <td><span class="step-num" style="background:var(--cat-optimize)">7</span></td>
          <td><span class="cat-badge cat-optimize">ìµœì í™”</span></td>
          <td><b>ì¸ìŠ¤íƒ€ ë¦´ìŠ¤</b><br><small style="color:var(--text3)">1080x1920 30fps 10Mbps + ì˜ìƒì„¸íƒ + ProShorts + 30ì´ˆ</small></td>
          <td style="font-size:11px;color:var(--text3)">ProShortsRenderer + FFmpeg</td>
          <td><span class="step-status pending" id="v3s-7">â¸ ëŒ€ê¸°</span></td>
        </tr>
        <tr data-step="8">
          <td><span class="step-num" style="background:var(--cat-deploy)">8</span></td>
          <td><span class="cat-badge cat-deploy">ë°°í¬</span></td>
          <td><b>ì—…ë¡œë“œ &amp; ì•„ì¹´ì´ë¹™</b><br><small style="color:var(--text3)">í”Œë«í¼ë³„ ìë™ ì—…ë¡œë“œ + Drive í•˜ìœ„í´ë” ë°±ì—…</small></td>
          <td style="font-size:11px;color:var(--text3)">StealthUploader + Drive</td>
          <td><span class="step-status pending" id="v3s-8">â¸ ëŒ€ê¸°</span></td>
        </tr>
      </tbody>
    </table>
    </div>
    <div class="progress-bar"><div class="progress-fill" id="pipe-progress"></div></div>
  </div>

  <!-- â•â•â• ë¯¸ë””ì–´ ëª¨ì•„ë³´ê¸° (4íƒ­) â•â•â• -->
  <div class="section">
    <div class="section-title"><span class="icon">ğŸ–¼ï¸</span> ë¯¸ë””ì–´ ëª¨ì•„ë³´ê¸°</div>
    <div class="media-panel">
      <div class="media-tabs">
        <button class="media-tab active" onclick="switchMediaTab('collected-img',this)">ğŸ“· ìˆ˜ì§‘ ì´ë¯¸ì§€</button>
        <button class="media-tab" onclick="switchMediaTab('collected-vid',this)">ğŸ¬ ìˆ˜ì§‘ ì˜ìƒ</button>
        <button class="media-tab" onclick="switchMediaTab('ai-gen',this)">ğŸ¤– AI ìƒì„±</button>
        <button class="media-tab" onclick="switchMediaTab('platform-out',this)">ğŸ“Š í”Œë«í¼ë³„ ê²°ê³¼</button>
      </div>
      <div class="media-body" id="media-body">
        <div class="media-empty">íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ í›„ ìˆ˜ì§‘/ìƒì„±ëœ ë¯¸ë””ì–´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</div>
      </div>
    </div>
  </div>

  <!-- â•â•â• 3í”Œë«í¼ ê²°ê³¼ â•â•â• -->
  <div class="section" id="result-section" style="display:none">
    <div class="section-title"><span class="icon">ğŸ“Š</span> í”Œë«í¼ë³„ ìµœì¢… ê²°ê³¼</div>
    <div class="result-grid" id="result-grid">
      <div class="result-empty">ì‹¤í–‰ í›„ í‘œì‹œë©ë‹ˆë‹¤</div>
    </div>
  </div>

  <!-- â•â•â• ìº í˜ì¸ ì´ë ¥ â•â•â• -->
  <div class="section">
    <div class="section-title">
      <span class="icon">ğŸ“‚</span> ìº í˜ì¸ ì´ë ¥
      <button class="btn btn-sm btn-outline" onclick="loadHistory()" style="margin-left:8px">ìƒˆë¡œê³ ì¹¨</button>
    </div>
    <div style="max-height:180px;overflow-y:auto">
      <table class="hist-table" id="hist-table">
        <thead><tr><th>ID</th><th>ì£¼ì œ</th><th>ìƒíƒœ</th><th>ë¹„ìš©</th><th>ë‚ ì§œ</th><th></th></tr></thead>
        <tbody id="hist-body"><tr><td colspan="6" style="text-align:center;color:var(--text3)">ë¡œë”© ì¤‘...</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- â•â•â• ì‹¤í–‰ ë¡œê·¸ â•â•â• -->
  <div class="section">
    <div class="section-title"><span class="icon">ğŸ“œ</span> ì‹¤í–‰ ë¡œê·¸ <button class="btn btn-sm btn-outline" onclick="clearLog()" style="margin-left:8px">í´ë¦¬ì–´</button></div>
    <div class="log-panel" id="log-panel">
      <div class="log-line"><span class="time">[--:--:--]</span> V3 íŒŒì´í”„ë¼ì¸ ëŒ€ê¸° ì¤‘...</div>
    </div>
  </div>

  <!-- â•â•â• ì‹œìŠ¤í…œ ìƒíƒœ â•â•â• -->
  <div class="section">
    <div class="section-title"><span class="icon">ğŸ”Œ</span> ì—°ê²° ì„œë¹„ìŠ¤</div>
    <div class="status-grid" id="status-grid"></div>
  </div>

  <!-- â•â•â• ë°ì´í„° ê´€ë¦¬ â•â•â• -->
  <div class="data-mgmt-bar">
    <span class="mgmt-label">ë°ì´í„° ê´€ë¦¬</span>
    <button class="btn-mgmt btn-backup" onclick="exportBackup()">ğŸ’¾ ë°±ì—…</button>
    <button class="btn-mgmt btn-restore" onclick="document.getElementById('import-file').click()">ğŸ“‚ ë³µì›</button>
    <button class="btn-mgmt btn-reset" onclick="resetAllData()">ğŸ—‘ ì´ˆê¸°í™”</button>
    <input type="file" id="import-file" accept=".json" style="display:none" onchange="importBackup(event)">
  </div>

</main>

<footer class="footer">
  &copy; 2026 YJ Partners MCN &mdash; V3.1 Ultimate Pipeline<br>
  NanoBanana Pro + Imagen 4.0 + VEO 3.1 + Gemini AI + Claude AI + FFmpeg GPU + Edge-TTS + Whisper | Flask :5001
</footer>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GitHub Pages ì ‘ì† ì‹œ â†’ localhost:5001 ë¦¬ë‹¤ì´ë ‰íŠ¸ (ì‚¬ìš©ì ì„ íƒ)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function() {
  if (location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
    // localStorageì— ì‚¬ìš©ì ì„ íƒ ê¸°ì–µ
    const pref = localStorage.getItem('mcn_redirect_pref');
    if (pref === 'stay') return; // ì´ì „ì— "ì—¬ê¸°ì„œ ë³´ê¸°" ì„ íƒ
    if (pref === 'redirect') { window.location.replace('http://localhost:5001'); return; }
    // ìµœì´ˆ ë°©ë¬¸: ì‚¬ìš©ìì—ê²Œ ì„ íƒ ìš”ì²­
    const choice = confirm(
      'YJ MCN ëŒ€ì‹œë³´ë“œëŠ” ë¡œì»¬ ì„œë²„(localhost:5001)ê°€ í•„ìš”í•©ë‹ˆë‹¤.\n\n' +
      '[í™•ì¸] â†’ localhost:5001ë¡œ ì´ë™\n' +
      '[ì·¨ì†Œ] â†’ ì´ í˜ì´ì§€ì—ì„œ ë³´ê¸° (ì„œë²„ ê¸°ëŠ¥ ì œí•œ)'
    );
    if (choice) {
      localStorage.setItem('mcn_redirect_pref', 'redirect');
      window.location.replace('http://localhost:5001');
    } else {
      localStorage.setItem('mcn_redirect_pref', 'stay');
    }
  }
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// V3 ìƒíƒœ ê´€ë¦¬
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const API = '';
let v3JobId = null;
let v3ES = null; // EventSource
let currentMediaTab = 'collected-img';
let currentDraftTab = 'blog';
let _draftData = {};
let _mediaData = { images: [], videos: [], ai: [], platform: {} };
let _lastResults = null;

const TOTAL_STEPS = 8;
const STEP_ICONS = {pending:'â¸',running:'ğŸ”„',complete:'âœ…',error:'âŒ',skipped:'â­'};
const STEP_LABELS = {pending:'ëŒ€ê¸°',running:'ì‹¤í–‰ ì¤‘',complete:'ì™„ë£Œ',error:'ì˜¤ë¥˜',skipped:'ê±´ë„ˆëœ€'};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ì´ˆê¸°í™”
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('DOMContentLoaded', () => {
  loadInputState();
  initInputPersistence();
  checkHealth();
  loadHistory();
  updateCost();
  setInterval(checkHealth, 30000);
  setInterval(updateCost, 60000);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// í—¬ìŠ¤ ì²´í¬ & ì„œë¹„ìŠ¤ ìƒíƒœ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function checkHealth() {
  try {
    const r = await fetch(API + '/api/health');
    if (!r.ok) throw new Error('Server error');
    const d = await r.json();
    const el = document.getElementById('status-badge');
    el.textContent = 'ONLINE ' + new Date().toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'});
    el.className = 'badge badge-online';
    renderServices(d.services);
  } catch(e) {
    const el = document.getElementById('status-badge');
    el.textContent = 'OFFLINE';
    el.className = 'badge';
    el.style.cssText = 'background:var(--red);color:#fff';
  }
}

function renderServices(svcs) {
  const names = {
    ollama:['Ollama','ë¡œì»¬ ë¬´ë£Œ'],gemini:['Gemini Flash','ë¬´ë£Œ'],gemini_pro:['Gemini Pro','ë¬´ë£Œ ìš¸íŠ¸ë¼'],
    claude_haiku:['Claude Haiku','ì €ê°€'],openai_mini:['GPT-4o-mini','ì €ê°€'],
    openai:['GPT-4o','ì¤‘ê°€'],claude_sonnet:['Claude Sonnet','ê³ ê°€'],openai_o1:['o1','ê³ ê°€'],
    pexels:['Pexels','ìŠ¤í†¡'],pixabay:['Pixabay','ìŠ¤í†¡'],unsplash:['Unsplash','ìŠ¤í†¡'],
    openclaw:['OpenClaw','ìë™í™”'],nano_banana:['NanoBanana','4K ì´ë¯¸ì§€'],veo:['VEO 3.1','ì˜ìƒ']
  };
  const grid = document.getElementById('status-grid');
  grid.innerHTML = Object.entries(svcs).map(([k,ok]) =>
    `<div class="status-item"><div class="status-dot ${ok?'on':'off'}"></div>
     <div><div class="status-name">${esc(names[k]?.[0]||k)}</div><div class="status-detail">${esc(names[k]?.[1]||'')}</div></div></div>`
  ).join('');
}

async function updateCost() {
  try {
    const r = await fetch(API + '/api/cost');
    const d = await r.json();
    const krw = ((d.total_usd||0)*1400).toFixed(0);
    document.getElementById('cost-badge').textContent = `API â‚©${Number(krw).toLocaleString()}`;
  } catch(e) { console.warn('Cost update failed:', e); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// V3 íŒŒì´í”„ë¼ì¸ ì‹œì‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function v3Start() {
  const coupangUrl = document.getElementById('inp-coupang-url').value.trim();
  if (!coupangUrl) { alert('ğŸ“¦ ì¿ íŒ¡ ìƒí’ˆ URLì„ ì…ë ¥í•˜ì„¸ìš”'); return; }

  const affiliateLink = document.getElementById('inp-affiliate').value.trim();
  if (!affiliateLink) { alert('ğŸ’° ì œíœ´ ë§í¬ë¥¼ ì…ë ¥í•˜ì„¸ìš” (link.coupang.com/a/...)'); return; }
  const bannerTag = document.getElementById('inp-banner').value.trim();
  const productName = document.getElementById('inp-product-name').value.trim();
  const socialUrls = document.getElementById('inp-social-urls').value.trim();
  const aiProvider = document.getElementById('sel-ai').value;
  const reviewMode = document.getElementById('chk-review').checked;

  const uploadFlags = {
    youtube: document.getElementById('up-yt').checked,
    instagram: document.getElementById('up-ig').checked,
    naver: document.getElementById('up-nv').checked,
    drive: document.getElementById('up-drive').checked,
  };

  // UI ë¦¬ì…‹
  resetPipeline();
  clearLog();
  hideDraftPanel();
  document.getElementById('result-section').style.display = 'none';
  document.getElementById('btn-v3-start').disabled = true;

  addLog('V3 íŒŒì´í”„ë¼ì¸ ì‹œì‘', 'ok');
  addLog('ìƒí’ˆ: ' + coupangUrl.slice(0, 60) + '...', 'ok');
  if (socialUrls) addLog('ì†Œì…œ URL: ' + socialUrls.split('\n').length + 'ê°œ', 'ok');

  try {
    const resp = await fetch(API + '/api/v3/campaign/start', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        coupang_url: coupangUrl,
        affiliate_link: affiliateLink,
        banner_tag: bannerTag,
        product_name: productName,
        social_urls: socialUrls ? socialUrls.split('\n').map(u=>u.trim()).filter(u=>u) : [],
        ai_provider: aiProvider,
        review_mode: reviewMode,
        upload_flags: uploadFlags,
      }),
    });
    const data = await resp.json();
    if (data.error) { addLog('ì˜¤ë¥˜: ' + data.error, 'err'); document.getElementById('btn-v3-start').disabled = false; return; }

    v3JobId = data.job_id;
    addLog('Job: ' + v3JobId, 'ok');

    // SSE ì—°ê²°
    if (v3ES) v3ES.close();
    v3ES = new EventSource(API + '/api/v3/campaign/stream/' + v3JobId);
    v3ES.onmessage = (e) => { try { v3HandleSSE(JSON.parse(e.data)); } catch(err) { console.warn('SSE parse error:', err); } };
    v3ES.onerror = () => {
      addLog('SSE ì—°ê²° ì¢…ë£Œ', 'warn');
      v3ES.close();
      document.getElementById('btn-v3-start').disabled = false;
    };
  } catch(e) {
    addLog('ì„œë²„ ì—°ê²° ì‹¤íŒ¨: ' + e.message, 'err');
    document.getElementById('btn-v3-start').disabled = false;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// V3 SSE í•¸ë“¤ëŸ¬
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function v3HandleSSE(msg) {

  // ë‹¨ê³„ ì§„í–‰
  if (msg.type === 'v3_step') {
    updateStep(msg.step, msg.status, msg.detail || '');
    const pct = Math.min((msg.step / TOTAL_STEPS) * 100, 100);
    document.getElementById('pipe-progress').style.width = pct + '%';
    addLog(`[Step ${msg.step}] ${msg.name || ''}: ${msg.detail || msg.status}`,
           msg.status === 'error' ? 'err' : 'ok');
  }

  // ì´ˆì•ˆ ë°ì´í„° ìˆ˜ì‹  (draft_ready)
  if (msg.type === 'draft_ready') {
    addLog('ğŸ“ ì´ˆì•ˆ ë°ì´í„° ìˆ˜ì‹  ì™„ë£Œ', 'ok');
    _draftData = msg.draft || {};
  }

  // ìƒíƒœ ë³€ê²½
  if (msg.type === 'state_change') {
    if (msg.message) addLog(msg.message, 'ok');

    // ì´ˆì•ˆ í™•ì¸ ëŒ€ê¸°
    if (msg.state === 'awaiting_confirm') {
      if (msg.draft) _draftData = msg.draft;
      showDraftPanel(_draftData);
    }
  }

  // ë¯¸ë””ì–´ ìˆ˜ì§‘ ê²°ê³¼
  if (msg.type === 'media_collected') {
    _mediaData.images = msg.images || [];
    _mediaData.videos = msg.videos || [];
    renderMediaTab();
    addLog(`ë¯¸ë””ì–´ ìˆ˜ì§‘: ì´ë¯¸ì§€ ${_mediaData.images.length}ê°œ, ì˜ìƒ ${_mediaData.videos.length}ê°œ`, 'ok');
  }

  // AI ë¯¸ë””ì–´ ìƒì„± ê²°ê³¼
  if (msg.type === 'ai_generated') {
    _mediaData.ai = msg.files || [];
    renderMediaTab();
    addLog(`AI ìƒì„±: ${_mediaData.ai.length}ê°œ`, 'ok');
  }

  // ë¸”ë¡œê·¸ ë¯¸ë¦¬ë³´ê¸° SSE
  if (msg.type === 'blog_preview') {
    addLog('ë¸”ë¡œê·¸ HTML ìƒì„± ì™„ë£Œ', 'ok');
  }

  // ì™„ë£Œ
  if (msg.type === 'v3_complete' || msg.type === 'v3_done') {
    document.getElementById('pipe-progress').style.width = '100%';
    addLog('ğŸ‰ V3 íŒŒì´í”„ë¼ì¸ 8ë‹¨ê³„ ì™„ë£Œ!', 'ok');
    document.getElementById('btn-v3-start').disabled = false;
    if (v3ES) v3ES.close();

    // ê²°ê³¼ í‘œì‹œ
    if (msg.results) {
      renderResults(msg.results);
      _mediaData.platform = msg.results;
    }
  }

  // ì—ëŸ¬
  if (msg.type === 'error') {
    addLog('ì˜¤ë¥˜: ' + (msg.error || msg.detail || ''), 'err');
    document.getElementById('btn-v3-start').disabled = false;
    if (v3ES) v3ES.close();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// V3 í™•ì¸ (ê²€í† ëª¨ë“œ í›„)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function v3Confirm() {
  if (!v3JobId) return;
  document.getElementById('btn-v3-confirm').disabled = true;
  addLog('ì´ˆì•ˆ í™•ì¸ â†’ ë‚˜ë¨¸ì§€ ë‹¨ê³„ ì‹¤í–‰ ì‹œì‘', 'ok');
  hideDraftPanel();
  try {
    await fetch(API + `/api/v3/campaign/${v3JobId}/confirm`, {
      method: 'POST', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({}),
    });
    // SSE ì¬ì—°ê²° â€” í™•ì¸ í›„ Step 3~8 ì´ë²¤íŠ¸ ìˆ˜ì‹ 
    if (v3ES) v3ES.close();
    v3ES = new EventSource(API + '/api/v3/campaign/stream/' + v3JobId);
    v3ES.onmessage = (e) => { try { v3HandleSSE(JSON.parse(e.data)); } catch(err) { console.warn('SSE parse error:', err); } };
    v3ES.onerror = () => {
      addLog('SSE ì—°ê²° ì¢…ë£Œ', 'warn');
      v3ES.close();
      document.getElementById('btn-v3-start').disabled = false;
    };
    addLog('SSE ì¬ì—°ê²° ì™„ë£Œ â€” Step 3~8 ìˆ˜ì‹  ì¤‘', 'ok');
  } catch(e) {
    addLog('í™•ì¸ ì˜¤ë¥˜: ' + e.message, 'err');
    document.getElementById('btn-v3-confirm').disabled = false;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// íŒŒì´í”„ë¼ì¸ ë‹¨ê³„ UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateStep(step, status, detail) {
  const el = document.getElementById('v3s-' + step);
  if (!el) return;
  el.className = 'step-status ' + status;
  el.textContent = (STEP_ICONS[status]||'') + ' ' + (STEP_LABELS[status]||status);
  // ìƒì„¸ ì •ë³´ í‘œì‹œ (í•´ë‹¹ í–‰ì˜ ëª¨ë“ˆ ì…€ ì˜†ì— ì¶”ê°€)
  if (detail) {
    const row = document.querySelector(`#pipe-table tr[data-step="${step}"]`);
    if (row) {
      let detailEl = row.querySelector('.step-detail');
      if (!detailEl) {
        detailEl = document.createElement('div');
        detailEl.className = 'step-detail';
        detailEl.style.cssText = 'font-size:10px;color:var(--text3);margin-top:2px;max-width:220px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap';
        el.parentElement.appendChild(detailEl);
      }
      detailEl.textContent = detail;
      detailEl.title = detail;
    }
  }
  // í™œì„± í–‰ í•˜ì´ë¼ì´íŠ¸
  document.querySelectorAll('#pipe-table tr[data-step]').forEach(tr => tr.classList.remove('active'));
  if (status === 'running') {
    const row = document.querySelector(`#pipe-table tr[data-step="${step}"]`);
    if (row) row.classList.add('active');
  }
}

function resetPipeline() {
  for (let i = 1; i <= TOTAL_STEPS; i++) updateStep(i, 'pending');
  document.getElementById('pipe-progress').style.width = '0%';
  _mediaData = { images: [], videos: [], ai: [], platform: {} };
  renderMediaTab();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ì´ˆì•ˆ íŒ¨ë„
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showDraftPanel(draft) {
  if (draft && Object.keys(draft).length > 0) _draftData = draft;
  document.getElementById('draft-panel').classList.add('visible');
  document.getElementById('btn-v3-confirm').disabled = false;
  currentDraftTab = 'blog';
  document.querySelectorAll('.draft-tab').forEach((t,i) => t.classList.toggle('active', i===0));
  renderDraftContent();
}

function hideDraftPanel() {
  document.getElementById('draft-panel').classList.remove('visible');
}

function switchDraftTab(tab, el) {
  currentDraftTab = tab;
  document.querySelectorAll('.draft-tab').forEach(t => t.classList.remove('active'));
  if (el) el.classList.add('active');
  renderDraftContent();
}

function renderDraftContent() {
  const body = document.getElementById('draft-body');
  if (currentDraftTab === 'blog') {
    const b = _draftData.blog || {};
    let txt = '';
    if (b.title) txt += `ğŸ“Œ ì œëª©: ${esc(b.title)}\n\n`;
    if (b.intro) txt += `ğŸ“ ì¸íŠ¸ë¡œ:\n${esc(b.intro)}\n\n`;
    (b.body_sections || []).forEach((s,i) => { txt += `[ë³¸ë¬¸${i+1}]\n${esc(s)}\n\n`; });
    if (b.cta) txt += `ğŸ›’ CTA: ${esc(b.cta)}\n\n`;
    if (b.hashtags) txt += `ğŸ·ï¸ ${(b.hashtags||[]).join(' ')}`;
    body.textContent = txt || '(ë¸”ë¡œê·¸ ì´ˆì•ˆì´ ì•„ì§ ì—†ìŠµë‹ˆë‹¤ â€” Step 2 ì§„í–‰ ì¤‘...)';
  } else if (currentDraftTab === 'shorts') {
    const s = _draftData.shorts || {};
    if (s.error) { body.textContent = 'âš ï¸ ìˆí¼ ëŒ€ë³¸ ìƒì„± ì‹¤íŒ¨: ' + s.error; return; }
    let txt = '';
    (s.scenes || []).forEach(sc => {
      txt += `ğŸ¬ ì¥ë©´${sc.scene_num}: [${sc.emotion||'friendly'}] ${sc.duration||5}ì´ˆ\n`;
      txt += `   "${esc(sc.text)}"\n\n`;
    });
    body.textContent = txt || '(ìˆí¼ ëŒ€ë³¸ ì—†ìŒ)';
  } else if (currentDraftTab === 'product') {
    const p = _draftData.product || {};
    let txt = `ğŸ“¦ ìƒí’ˆëª…: ${esc(p.title || '(ì—†ìŒ)')}\n`;
    txt += `ğŸ’° ê°€ê²©: ${esc(p.price || '(ì—†ìŒ)')}\n`;
    txt += `ğŸ”— ì œíœ´ë§í¬: ${esc(p.affiliate_link || '(ì—†ìŒ)')}\n`;
    if (p.description) txt += `\nğŸ“ ì„¤ëª…:\n${esc(p.description.slice(0, 300))}`;
    body.textContent = txt;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ë¯¸ë””ì–´ íƒ­
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchMediaTab(tab, el) {
  currentMediaTab = tab;
  document.querySelectorAll('.media-tab').forEach(t => t.classList.remove('active'));
  if (el) el.classList.add('active');
  renderMediaTab();
}

function renderMediaTab() {
  const body = document.getElementById('media-body');
  let items = [];
  let isVideo = false;

  if (currentMediaTab === 'collected-img') {
    items = _mediaData.images || [];
  } else if (currentMediaTab === 'collected-vid') {
    items = _mediaData.videos || [];
    isVideo = true;
  } else if (currentMediaTab === 'ai-gen') {
    items = _mediaData.ai || [];
  } else {
    // í”Œë«í¼ë³„ ê²°ê³¼
    const p = _mediaData.platform || {};
    if (p.naver_blog || p.youtube || p.instagram) {
      let html = '<div style="display:flex;gap:12px;flex-wrap:wrap">';
      if (p.naver_blog) html += `<div style="flex:1;min-width:200px;background:var(--card2);border-radius:8px;padding:12px"><div style="font-size:12px;font-weight:700;color:var(--naver);margin-bottom:4px">ğŸ“— ë„¤ì´ë²„ ë¸”ë¡œê·¸</div><div style="font-size:11px;color:var(--text2)">ì´ë¯¸ì§€ ${p.naver_blog.image_count||0}ì¥ | HTML ìƒì„± ì™„ë£Œ</div></div>`;
      if (p.youtube) html += `<div style="flex:1;min-width:200px;background:var(--card2);border-radius:8px;padding:12px"><div style="font-size:12px;font-weight:700;color:var(--youtube);margin-bottom:4px">ğŸ“º ìœ íŠœë¸Œ ì‡¼ì¸ </div><div style="font-size:11px;color:var(--text2)">60fps 12Mbps | ${p.youtube.duration||45}ì´ˆ</div></div>`;
      if (p.instagram) html += `<div style="flex:1;min-width:200px;background:var(--card2);border-radius:8px;padding:12px"><div style="font-size:12px;font-weight:700;color:var(--insta);margin-bottom:4px">ğŸ“¸ ì¸ìŠ¤íƒ€ ë¦´ìŠ¤</div><div style="font-size:11px;color:var(--text2)">30fps 10Mbps | ${p.instagram.duration||30}ì´ˆ</div></div>`;
      html += '</div>';
      body.innerHTML = html;
      return;
    }
    body.innerHTML = '<div class="media-empty">í”Œë«í¼ë³„ ê²°ê³¼ê°€ ì•„ì§ ì—†ìŠµë‹ˆë‹¤</div>';
    return;
  }

  if (!items.length) {
    body.innerHTML = '<div class="media-empty">ì•„ì§ ìˆ˜ì§‘/ìƒì„±ëœ ë¯¸ë””ì–´ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
    return;
  }

  if (isVideo) {
    body.innerHTML = '<div class="media-grid">' + items.map(v => {
      const src = typeof v === 'string' ? v : (v.path || v.url || '');
      const fileUrl = src.startsWith('http') ? src : `/api/file/${encodeURIComponent(src)}`;
      return `<div style="position:relative"><video src="${esc(fileUrl)}" style="width:100%;border-radius:6px;aspect-ratio:9/16;object-fit:cover;background:#000" controls preload="metadata"></video></div>`;
    }).join('') + '</div>';
  } else {
    body.innerHTML = '<div class="media-grid">' + items.map(img => {
      const src = typeof img === 'string' ? img : (img.path || img.url || img.thumb || '');
      const fileUrl = src.startsWith('http') ? src : `/api/file/${encodeURIComponent(src)}`;
      const title = typeof img === 'object' ? esc(img.title || img.source || '') : '';
      return `<img class="media-thumb" src="${esc(fileUrl)}" title="${title}" loading="lazy" onerror="this.style.display='none'" />`;
    }).join('') + '</div>';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 3í”Œë«í¼ ìµœì¢… ê²°ê³¼
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderResults(results) {
  const section = document.getElementById('result-section');
  const grid = document.getElementById('result-grid');
  section.style.display = 'block';

  const cfgs = {
    naver_blog: {icon:'ğŸ“—',name:'ë„¤ì´ë²„ ë¸”ë¡œê·¸',badge:'badge-naver',tag:'Blog'},
    youtube:    {icon:'ğŸ“º',name:'ìœ íŠœë¸Œ ì‡¼ì¸ ',badge:'badge-youtube',tag:'Shorts'},
    instagram:  {icon:'ğŸ“¸',name:'ì¸ìŠ¤íƒ€ ë¦´ìŠ¤',badge:'badge-insta',tag:'Reels'},
  };

  let html = '';
  for (const [pName, pData] of Object.entries(results.platforms || {})) {
    const cfg = cfgs[pName];
    if (!cfg) continue;
    const content = pData.content || {};
    const tags = (content.hashtags || []).map(t => `<span class="tag">${esc(t)}</span>`).join('');

    const hasVideo = pData.video && pData.video !== 'None';
    const hasThumb = pData.thumbnail && pData.thumbnail !== 'None';
    const vidUrl = hasVideo ? `/api/file/${encodeURIComponent(pData.video)}` : '';
    const thumbUrl = hasThumb ? `/api/file/${encodeURIComponent(pData.thumbnail)}` : '';

    let preview = '';
    if (hasVideo) preview = `<div class="result-preview"><video src="${vidUrl}" controls preload="metadata" poster="${thumbUrl}"></video></div>`;
    else if (hasThumb) preview = `<div class="result-preview"><img src="${thumbUrl}" alt="thumb"></div>`;

    html += `<div class="result-card">
      <div class="result-card-header">
        <span class="plat-icon">${cfg.icon}</span>
        <span class="plat-name">${cfg.name}</span>
        <span class="plat-badge ${cfg.badge}">${cfg.tag}</span>
      </div>
      <div class="result-card-body">
        ${preview}
        <div class="result-field"><span class="result-label">ì œëª©</span><div class="result-value" style="font-weight:600">${esc(content.title||'')}</div></div>
        <div class="result-field"><span class="result-label">${pName==='naver_blog'?'ë³¸ë¬¸':'ìº¡ì…˜'}</span><div class="result-value">${esc(content.body||content.caption||content.description||'')}</div></div>
        ${tags?`<div class="result-field"><span class="result-label">í•´ì‹œíƒœê·¸</span><div class="tag-cloud">${tags}</div></div>`:''}
      </div>
      <div class="result-card-footer">
        <button class="btn btn-sm btn-outline" onclick="copyResult('${pName}')">ğŸ“‹ ë³µì‚¬</button>
        ${hasVideo?`<button class="btn btn-sm btn-green" onclick="window.open('${vidUrl}')">ğŸ“¥ ì˜ìƒ</button>`:''}
        ${hasThumb?`<button class="btn btn-sm btn-outline" onclick="window.open('${thumbUrl}')">ğŸ–¼ï¸ ì¸ë„¤ì¼</button>`:''}
      </div>
    </div>`;
  }

  // Drive ê²°ê³¼
  if (results.drive_url) {
    html += `<div style="grid-column:1/-1;background:var(--card);border:1px solid var(--blue);border-radius:14px;padding:14px;display:flex;align-items:center;gap:12px">
      <span style="font-size:28px">â˜ï¸</span>
      <div style="flex:1"><div style="font-size:13px;font-weight:700;color:var(--blue)">Drive ì•„ì¹´ì´ë¹™ ì™„ë£Œ</div>
      <div style="font-size:11px;color:var(--text2)">${results.drive_files_uploaded||0}ê°œ íŒŒì¼ ì—…ë¡œë“œ</div></div>
      <a href="${esc(results.drive_url)}" target="_blank" class="btn btn-sm" style="background:var(--blue);color:#fff">ğŸ“‚ ì—´ê¸°</a>
    </div>`;
  }

  grid.innerHTML = html || '<div class="result-empty">ê²°ê³¼ ì—†ìŒ</div>';
  _lastResults = results;
}

function copyResult(platform) {
  if (!_lastResults) return;
  const p = _lastResults.platforms?.[platform];
  if (!p || !p.content) return;
  const c = p.content;
  let txt = '';
  if (c.title) txt += c.title + '\n\n';
  if (c.body) txt += c.body + '\n\n';
  if (c.caption) txt += c.caption + '\n\n';
  if (c.hashtags) txt += c.hashtags.join(' ');
  navigator.clipboard.writeText(txt).then(() => addLog(platform + ' ë³µì‚¬ ì™„ë£Œ','ok'));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ìº í˜ì¸ ì´ë ¥
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadHistory() {
  try {
    const r = await fetch(API + '/api/campaigns?limit=15');
    const data = await r.json();
    const body = document.getElementById('hist-body');
    if (!data.length) { body.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--text3)">ì´ë ¥ ì—†ìŒ</td></tr>'; return; }
    body.innerHTML = data.map(c => {
      const icon = c.status==='complete'?'âœ…':c.status==='error'?'âŒ':c.status==='running'?'ğŸ”„':'â¸';
      const cls = c.status==='complete'?'ok':c.status==='error'?'err':'';
      const date = c.created_at ? new Date(c.created_at).toLocaleString('ko-KR',{month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'}) : '';
      const safeId = esc((c.id||'').slice(0,12));
      return `<tr>
        <td style="font-family:monospace;font-size:10px">${esc((c.id||'').slice(0,8))}</td>
        <td><b>${esc((c.topic||'').slice(0,35))}</b></td>
        <td><span class="log-line ${cls}" style="margin:0">${icon} ${esc(c.status||'')}</span></td>
        <td style="font-size:10px">$${(c.cost_usd||0).toFixed(4)}</td>
        <td style="font-size:10px">${esc(date)}</td>
        <td>${c.status==='complete'?`<button class="btn btn-sm btn-outline" onclick="reuse('${safeId}')">ì¬ì‚¬ìš©</button>`:''}</td>
      </tr>`;
    }).join('');
  } catch(e) {
    document.getElementById('hist-body').innerHTML = '<tr><td colspan="6" style="color:var(--red)">ë¡œë”© ì‹¤íŒ¨</td></tr>';
  }
}

async function reuse(id) {
  try {
    const r = await fetch(API + '/api/campaigns/' + id);
    const d = await r.json();
    if (d.topic) {
      document.getElementById('inp-coupang-url').value = d.topic;
      addLog('ìº í˜ì¸ ì¬ì‚¬ìš©: ' + d.topic, 'ok');
    }
    // ê²°ê³¼ì—ì„œ ì¶”ê°€ í•„ë“œ ë³µì›
    if (d.results) {
      try {
        const res = typeof d.results === 'string' ? JSON.parse(d.results) : d.results;
        if (res.affiliate_link) document.getElementById('inp-affiliate').value = res.affiliate_link;
        if (res.banner_tag) document.getElementById('inp-banner').value = res.banner_tag;
        if (res.product_name) document.getElementById('inp-product-name').value = res.product_name;
      } catch(_) {}
    }
  } catch(e) { addLog('ì¬ì‚¬ìš© ì‹¤íŒ¨: ' + e.message, 'err'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ë¡œê·¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addLog(msg, type) {
  const panel = document.getElementById('log-panel');
  const time = new Date().toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
  const cls = type==='ok'?'ok':type==='err'?'err':type==='warn'?'warn':'';
  panel.insertAdjacentHTML('beforeend', `<div class="log-line ${cls}"><span class="time">[${time}]</span> ${esc(msg)}</div>`);
  panel.scrollTop = panel.scrollHeight;
}
function clearLog() { document.getElementById('log-panel').innerHTML = ''; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ìœ í‹¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function esc(s) {
  if (!s) return '';
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// localStorage ì…ë ¥ ìƒíƒœ ì €ì¥/ë³µì›
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MCN_STORAGE_KEY = 'mcn_inputs';

function saveInputState() {
  try {
    const state = {
      coupangUrl: document.getElementById('inp-coupang-url').value,
      affiliateLink: document.getElementById('inp-affiliate').value,
      bannerTag: document.getElementById('inp-banner').value,
      productName: document.getElementById('inp-product-name').value,
      socialUrls: document.getElementById('inp-social-urls').value,
      aiProvider: document.getElementById('sel-ai').value,
      chkReview: document.getElementById('chk-review').checked,
      upYt: document.getElementById('up-yt').checked,
      upIg: document.getElementById('up-ig').checked,
      upNv: document.getElementById('up-nv').checked,
      upDrive: document.getElementById('up-drive').checked,
    };
    localStorage.setItem(MCN_STORAGE_KEY, JSON.stringify(state));
  } catch(e) { console.warn('saveInputState ì‹¤íŒ¨:', e); }
}

function loadInputState() {
  try {
    const raw = localStorage.getItem(MCN_STORAGE_KEY);
    if (!raw) return;
    const s = JSON.parse(raw);
    if (s.coupangUrl) document.getElementById('inp-coupang-url').value = s.coupangUrl;
    if (s.affiliateLink) document.getElementById('inp-affiliate').value = s.affiliateLink;
    if (s.bannerTag) document.getElementById('inp-banner').value = s.bannerTag;
    if (s.productName) document.getElementById('inp-product-name').value = s.productName;
    if (s.socialUrls) document.getElementById('inp-social-urls').value = s.socialUrls;
    if (s.aiProvider) document.getElementById('sel-ai').value = s.aiProvider;
    if (typeof s.chkReview === 'boolean') document.getElementById('chk-review').checked = s.chkReview;
    if (typeof s.upYt === 'boolean') document.getElementById('up-yt').checked = s.upYt;
    if (typeof s.upIg === 'boolean') document.getElementById('up-ig').checked = s.upIg;
    if (typeof s.upNv === 'boolean') document.getElementById('up-nv').checked = s.upNv;
    if (typeof s.upDrive === 'boolean') document.getElementById('up-drive').checked = s.upDrive;
  } catch(e) { console.warn('loadInputState ì‹¤íŒ¨:', e); }
}

function initInputPersistence() {
  // í…ìŠ¤íŠ¸ ì…ë ¥ í•„ë“œ â€” input ì´ë²¤íŠ¸ë¡œ ì‹¤ì‹œê°„ ì €ì¥
  ['inp-coupang-url','inp-affiliate','inp-banner','inp-product-name','inp-social-urls'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.addEventListener('input', saveInputState);
  });
  // select
  const selAi = document.getElementById('sel-ai');
  if (selAi) selAi.addEventListener('change', saveInputState);
  // ì²´í¬ë°•ìŠ¤ í† ê¸€
  ['chk-review','up-yt','up-ig','up-nv','up-drive'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.addEventListener('change', saveInputState);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ë°±ì—…/ë³µì›/ì´ˆê¸°í™”
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportBackup() {
  const data = {
    _app: 'YJ Partners MCN',
    _version: 'V3.1',
    _date: new Date().toISOString(),
    inputs: JSON.parse(localStorage.getItem(MCN_STORAGE_KEY) || '{}'),
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'MCN_Backup_' + new Date().toISOString().slice(0, 10) + '.json';
  a.click();
  URL.revokeObjectURL(a.href);
  addLog('ë°±ì—… íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ', 'ok');
}

function importBackup(ev) {
  const file = ev.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      if (!data._app || data._app !== 'YJ Partners MCN') {
        alert('ì˜¬ë°”ë¥¸ MCN ë°±ì—… íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤.');
        return;
      }
      if (data.inputs) {
        localStorage.setItem(MCN_STORAGE_KEY, JSON.stringify(data.inputs));
        addLog('ë°±ì—… ë³µì› ì™„ë£Œ (' + (data._date || 'ë‚ ì§œ ë¶ˆëª…') + ')', 'ok');
        alert('ë³µì› ì™„ë£Œ! í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.');
        location.reload();
      } else {
        alert('ë°±ì—… ë°ì´í„°ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.');
      }
    } catch(err) {
      alert('ì˜¬ë°”ë¥¸ ë°±ì—… íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤.');
    }
  };
  reader.readAsText(file);
  ev.target.value = '';
}

async function checkPW(input) {
  const data = new TextEncoder().encode(input);
  const hashBuf = await crypto.subtle.digest('SHA-256', data);
  const hash = Array.from(new Uint8Array(hashBuf)).map(b => b.toString(16).padStart(2, '0')).join('');
  return hash === '878f96264ece1c85973dfa3b39dec9a7dc4cf6f08168ff5a183389a36b1bb9d0';
}

async function resetAllData() {
  const pw = prompt('ì´ˆê¸°í™”ë¥¼ ìœ„í•´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
  if (pw === null) return;
  if (!(await checkPW(pw))) { alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.'); return; }
  if (!confirm('ëª¨ë“  ì €ì¥ëœ ì…ë ¥ ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) return;
  localStorage.removeItem(MCN_STORAGE_KEY);
  addLog('ì „ì²´ ë°ì´í„° ì´ˆê¸°í™” ì™„ë£Œ', 'warn');
  alert('ì´ˆê¸°í™” ì™„ë£Œ! í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.');
  location.reload();
}
</script>
</body>
</html>
